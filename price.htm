<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, monospace;
    }

    table {
      border-collapse: collapse;
    }

    td {
      white-space: nowrap;
      word-wrap: keep-all;
      word-break: keep-all;
    }

    .right {
      text-align: right;
    }

    .typeZ {
      background-color: #004a80;
      color: #ffffff;
    }

    .typeT {
      background-color: #1445b8;
      color: #c32230;
    }

    .typeK,
    .typeY,
    .type1,
    .type2,
    .type3,
    .type4,
    .type5,
    .type6,
    .type7,
    .type8,
    .type9 {
      background-color: #cc4c33;
      color: #ffffff;
    }

    .type200J {
      background-color: #29a352;
      color: #e6cc4c
    }

    .typeservice_0 {
      background-color: #567e60;
      color: #fff700
    }

    .typeG {
      background-color: #d4d4d4;
      color: #a80022
    }

    .typeC {
      background-color: #bf9540;
      color: #ffffff;
    }

    .typeD,
    .typeS {
      background-color: #ffffff;
      color: #3d668f;
    }

    .abs {
      position: absolute;
    }

    .seat_match {
      font-weight: bold;
      text-decoration-line: underline;
      text-decoration-color: #cccccc;
      -webkit-text-decoration-color: #cccccc;
    }

    #pricetable tr:hover {
      font-weight: bold;
      text-decoration-line: underline;
      text-decoration-color: #FF0000;
      -webkit-text-decoration-color: #FF0000;
    }
  </style>
</head>

<body>
  <form>
    基本费率 0.05861
    上浮 <input type="text" id="up" value="0.5" placeholder="上浮" style="max-width:3em" />
    空调 <input type="text" id="kd" value="1" placeholder="空调" style="max-width:3em" />
    加快 <input type="text" id="fast" value="2" placeholder="加快" style="max-width:3em" />
    退保险 <input type="text" id="bxoff" value="1" placeholder="退保险" style="max-width:3em" />
    <span onclick="setHTML('pricetable', priceHTML(pricetable(Number(getValue('up')), Number(getValue('kd')), Number(getValue('fast')), Number(getValue('bxoff')))));return false">票价表</span>
  </form>
  </form>

  <div id="pricetable"></div>

  <pre>
计算里程|所属区段|小区段里程|区段数|N|正负号
硬座|软座|基本票|保险费
硬卧上|硬卧中|硬卧下|软卧上|软卧下|高包上|高包下|普快票|空调票|候车室空调|客票发展金|卧铺订票费


A4 = 1-20
B4 = 20
C4=IF(B4=0,0,IF(B4>0,(ROUND(G4,0)+H4*0.5)*E4+D4))
D4=IF(B4<=1100,(IF(B4<=200,0,IF(B4<=400,200,IF(B4<=700,400,IF(B4<=1100,700))))),IF(B4<=1600,1100,IF(B4<=2200,1600,IF(B4<=2900,2200,IF(B4<=3700,2900,IF(B4<=4600,3700,IF(B4>4600,4600)))))))
E4=IF(B4<=1100,(IF(B4<=200,10,IF(B4<=400,20,IF(B4<=700,30,IF(B4<=1100,40))))),IF(B4<=1600,50,IF(B4<=2200,60,IF(B4<=2900,70,IF(B4<=3700,80,IF(B4<=4600,90,IF(B4>4600,100)))))))
F4=IF(B4<=200,20,IF(B4<=4600,10,1))
G4=(B4-D4)/E4
H4=IF((G4-ROUND(G4,0))<=0,-1,IF((G4-ROUND(G4,0))>0,1))


基本K4=IF(C4<=20,0.05861*20,IF(C4<=200,0.05861*C4,IF(C4<=500,(0.05861*200+0.05861*0.9*(C4-200)),IF(C4<=1000,(0.05861*200+0.05861*0.9*300+0.05861*0.8*(C4-500)),IF(C4<=1500,(0.05861*200+0.05861*0.9*300+0.05861*0.8*500+0.05861*0.7*(C4-1000)),IF(C4<=2500,(0.05861*200+0.05861*0.9*300+0.05861*0.8*500+0.05861*0.7*500+0.05861*0.6*(C4-1500)),IF(C4>2500,(0.05861*200+0.05861*0.9*300+0.05861*0.8*500+0.05861*0.7*500+0.05861*0.6*1000+0.05861*0.5*(C4-2500)))))))))
保险 舍入前 L4=ROUNDUP(K4*0.02,1)
硬座 I4=ROUND(K4+L4,0)
软座 J4=ROUND(K4*2+L4,0)


1.1 1.2 1.3  1.75 1.95  2.1 2.3x
=ROUND(IF(C4<=400,(0.06447*200+0.06447*0.9*200),IF(C4<=500,(0.06447*200+0.06447*0.9*(C4-200)),IF(C4<=1000,(0.06447*200+0.06447*0.9*300+0.06447*0.8*(C4-500)),IF(C4<=1500,(0.06447*200+0.06447*0.9*300+0.06447*0.8*500+0.06447*0.7*(C4-1000)),IF(C4<=2500,(0.06447*200+0.06447*0.9*300+0.06447*0.8*500+0.06447*0.7*500+0.06447*0.6*(C4-1500)),IF(C4>2500,(0.06447*200+0.06447*0.9*300+0.06447*0.8*500+0.06447*0.7*500+0.06447*0.6*1000+0.06447*0.5*(C4-2500)))))))),0)
=ROUND(IF(C4<=400,(0.07033*200+0.07033*0.9*200),IF(C4<=500,(0.07033*200+0.07033*0.9*(C4-200)),IF(C4<=1000,(0.07033*200+0.07033*0.9*300+0.07033*0.8*(C4-500)),IF(C4<=1500,(0.07033*200+0.07033*0.9*300+0.07033*0.8*500+0.07033*0.7*(C4-1000)),IF(C4<=2500,(0.07033*200+0.07033*0.9*300+0.07033*0.8*500+0.07033*0.7*500+0.07033*0.6*(C4-1500)),IF(C4>2500,(0.07033*200+0.07033*0.9*300+0.07033*0.8*500+0.07033*0.7*500+0.07033*0.6*1000+0.07033*0.5*(C4-2500)))))))),0)
=ROUND(IF(C4<=400,(0.07619*200+0.07619*0.9*200),IF(C4<=500,(0.07619*200+0.07619*0.9*(C4-200)),IF(C4<=1000,(0.07619*200+0.07619*0.9*300+0.07619*0.8*(C4-500)),IF(C4<=1500,(0.07619*200+0.07619*0.9*300+0.07619*0.8*500+0.07619*0.7*(C4-1000)),IF(C4<=2500,(0.07619*200+0.07619*0.9*300+0.07619*0.8*500+0.07619*0.7*500+0.07619*0.6*(C4-1500)),IF(C4>2500,(0.07619*200+0.07619*0.9*300+0.07619*0.8*500+0.07619*0.7*500+0.07619*0.6*1000+0.07619*0.5*(C4-2500)))))))),0)

=ROUND(IF(C4<=400,(0.10257*200+0.10257*0.9*200),IF(C4<=500,(0.10257*200+0.10257*0.9*(C4-200)),IF(C4<=1000,(0.10257*200+0.10257*0.9*300+0.10257*0.8*(C4-500)),IF(C4<=1500,(0.10257*200+0.10257*0.9*300+0.10257*0.8*500+0.10257*0.7*(C4-1000)),IF(C4<=2500,(0.10257*200+0.10257*0.9*300+0.10257*0.8*500+0.10257*0.7*500+0.10257*0.6*(C4-1500)),IF(C4>2500,(0.10257*200+0.10257*0.9*300+0.10257*0.8*500+0.10257*0.7*500+0.10257*0.6*1000+0.10257*0.5*(C4-2500)))))))),0)
=ROUND(IF(C4<=400,(0.11429*200+0.11429*0.9*200),IF(C4<=500,(0.11429*200+0.11429*0.9*(C4-200)),IF(C4<=1000,(0.11429*200+0.11429*0.9*300+0.11429*0.8*(C4-500)),IF(C4<=1500,(0.11429*200+0.11429*0.9*300+0.11429*0.8*500+0.11429*0.7*(C4-1000)),IF(C4<=2500,(0.11429*200+0.11429*0.9*300+0.11429*0.8*500+0.11429*0.7*500+0.11429*0.6*(C4-1500)),IF(C4>2500,(0.11429*200+0.11429*0.9*300+0.11429*0.8*500+0.11429*0.7*500+0.11429*0.6*1000+0.11429*0.5*(C4-2500)))))))),0)

=ROUND(IF(C4<=400,(0.12308*200+0.12308*0.9*200),IF(C4<=500,(0.12308*200+0.12308*0.9*(C4-200)),IF(C4<=1000,(0.12308*200+0.12308*0.9*300+0.12308*0.8*(C4-500)),IF(C4<=1500,(0.12308*200+0.12308*0.9*300+0.12308*0.8*500+0.12308*0.7*(C4-1000)),IF(C4<=2500,(0.12308*200+0.12308*0.9*300+0.12308*0.8*500+0.12308*0.7*500+0.12308*0.6*(C4-1500)),IF(C4>2500,(0.12308*200+0.12308*0.9*300+0.12308*0.8*500+0.12308*0.7*500+0.12308*0.6*1000+0.12308*0.5*(C4-2500)))))))),0)
=ROUND(IF(C4<=400,(0.13480*200+0.13480*0.9*200),IF(C4<=500,(0.13480*200+0.13480*0.9*(C4-200)),IF(C4<=1000,(0.13480*200+0.13480*0.9*300+0.13480*0.8*(C4-500)),IF(C4<=1500,(0.13480*200+0.13480*0.9*300+0.13480*0.8*500+0.13480*0.7*(C4-1000)),IF(C4<=2500,(0.13480*200+0.13480*0.9*300+0.13480*0.8*500+0.13480*0.7*500+0.13480*0.6*(C4-1500)),IF(C4>2500,(0.13480*200+0.13480*0.9*300+0.13480*0.8*500+0.13480*0.7*500+0.13480*0.6*1000+0.13480*0.5*(C4-2500)))))))),0)



加快T4=IF(ROUND(K4*0.2,0)<1,1,IF(ROUND(K4*0.2,0)>=1,ROUND(K4*0.2,0)))
AA = T4
AB = T4 * 2

BD =ROUND(T4*1.5,0)
BE = BD * 2


空调U4=IF(ROUND(K4*0.25,0)<1,1,IF(ROUND(K4*0.25,0)>=1,ROUND(K4*0.25,0)))
AH=U4
BK=ROUND(U4*1.5,0)


候车室空调 V=IF(C4<=200,0,IF(C4>200,1))   硬座>200km
W=IF(I4<=5,0.5,IF(I4>5,1)) 客票发展金
X=10 卧铺订票费

座         候车室空调                        客票发展金             -保险费
Y=       I4       +V4  +IF(      I4       +V4<=5,0.5,1) -ROUNDUP($L4/5,1)*5
Z=       J4            +IF(      J4          <=5,0.5,1) -ROUNDUP($L4/5,1)*5

BB=ROUND(I4*1.5,0)+V4  +IF(ROUND(I4*1.5,0)+V4<=5,0.5,1) -ROUNDUP($L4/5,1)*5
BC=ROUND(J4*1.5,0)     +IF(ROUND(J4*1.5,0)   <=5,0.5,1) -ROUNDUP($L4/5,1)*5

铺
AC=IF(B32<400,0,M32+X32)
...
AG

BF=IF(B32<400,0,ROUND(M32*1.5,0)+X32)
...
BJ



CB4=ROUNDUP($L4/5,1)*5


0.05861*
  </pre>

  <pre>
/*
清河-张家口
0.80 72
0.85 77
0.88 79
0.92 83
0.95 86
1.00 90 公布
*/
  </pre>

  <script>

    function setHTML(id, str) {
      e = document.getElementById(id);
      e && (e.innerHTML = str);
    }

    function setValue(id, str) {
      e = document.getElementById(id);
      e && (e.value = str);
    }

    function getValue(id) {
      e = document.getElementById(id);
      return e ? e.value : "";
    }

    function gen_sections() {
      var ret = []
      var ans = 0;
      var last = 0;
      for (var i = 1; i <= 10; i++) {
        n = 10;
        if (i == 1) { n = 20 }
        if (i == 10) { n = 14 }
        for (var ii = 1; ii <= n; ii++) {
          last = ans;
          ans += i * 10;
          // console.log(ans, (ans + last) / 2, i * 10, n, ii)
          ret.push({
            "floor": last,
            "ceil": ans,
            "center": (ans + last) / 2
          })
          last = ans;
        }
      }

      ret.shift()
      ret[0].floor = 0

      return ret
    }


    function binary_search(arr, idx, key) {
      var low = 0, high = arr.length - 1;
      while (low < high) {
        var mid = low + ((high - low) >> 2);
        console.log(low, high, mid, arr[mid])
        if (key <= arr[mid][idx]) {
          high = mid;
        }
        if (key > arr[mid][idx]) {
          low = mid + 1;
        }
      }
      console.log("end", low, high, mid, arr[mid])
      return low
    };
    //binary_search(rows, 15, 43.5)
    //binary_search(rows, 17, 261.5)
    //binary_search(rows, 20, 409.5)

    function at_least(x, n) {
      if (x < n) {
        return n
      }
      return x
    }


    function miles_off(x) {
      if (x > 2500) {
        return .5 * x + 570 //(x - 2500) * .5 + 1000 * .6 + 500 * .7 + 500 * .8 + 300 * .9 + 200
      }
      if (x > 1500) {
        return .6 * x + 320 //(x - 1500) * .6 + 500 * .7 + 500 * .8 + 300 * .9 + 200
      }
      if (x > 1000) {
        return .7 * x + 170 //(x - 1000) * .7 + 500 * .8 + 300 * .9 + 200
      }
      if (x > 500) {
        return .8 * x + 70 //(x - 500) * .8 + 300 * .9 + 200
      }
      if (x > 200) {
        return .9 * x + 20 //(x - 200) * .9 + 200
      }
      return x
    }

    function miles_off_emu(x) {
      if (x > 2500) {
        return .5 * x + 750 //(x - 2500) * .5 + 500 * .6 + 500 * .7 + 500 * .8 + 500 * .9 + 500
      }
      if (x > 2000) {
        return .6 * x + 500 //(x - 2000) * .6 + 500 * .7 + 500 * .8 + 500 * .9 + 500
      }
      if (x > 1500) {
        return .7 * x + 300 //(x - 1500) * .7 + 500 * .8 + 500 * .9 + 500
      }
      if (x > 1000) {
        return .8 * x + 150 //(x - 1000) * .8 + 500 * .9 + 500
      }
      if (x > 500) {
        return .9 * x + 50 //(x - 500) * .9 + 500
      }
      return x
    }

    function unionprice(x, up, kd, fast, bxoff) {
      var km = miles_off(x)

      var bx = Math.ceil(km * 0.05861 * 0.02 * 10) / 10
      var hcs = x > 200 ? 1 : 0 //候车室空调
      var yz0 = km * 0.05861
      var rz0 = km * 0.05861 * 2
      var bx1 = Math.ceil(bx * 2) / 2

      var yz = Math.round((1 + up) * Math.round(yz0 + bx)) + hcs
      var rz = Math.round((1 + up) * Math.round(rz0 + bx))

      //客票发展金
      yz += yz <= 5 ? 0.5 : 1
      rz += yz <= 5 ? 0.5 : 1

      yz -= bx1 * bxoff
      rz -= bx1 * bxoff

      var jk = Math.round(km * 0.05861 * 0.2)
      if (jk < 1) {
        jk = 1
      }
      jk = Math.round((1 + up) * jk)
      var kt = Math.round(km * 0.05861 * 0.25)
      if (kt < 1) {
        kt = 1
      }
      kt = Math.round((1 + up) * kt)

      km = miles_off(at_least(x, 400)) //卧铺起步400km

      var yw1 = Math.round((1 + up) * Math.round(km * 0.05861 * 1.1)) + 10
      var yw2 = Math.round((1 + up) * Math.round(km * 0.05861 * 1.2)) + 10
      var yw3 = Math.round((1 + up) * Math.round(km * 0.05861 * 1.3)) + 10

      //yb1 = yw2 (1+0.3)
      //yb3 = yw3 (1+0.3)

      var rw1 = Math.round((1 + up) * Math.round(km * 0.05861 * 1.75)) + 10
      var rw3 = Math.round((1 + up) * Math.round(km * 0.05861 * 1.95)) + 10
      var gr1 = Math.round((1 + up) * Math.round(km * 0.05861 * 2.1)) + 10
      var gr3 = Math.round((1 + up) * Math.round(km * 0.05861 * 2.3)) + 10

      var ret = []
      ret.push(
        yz, rz,
        jk, fast * jk,
        kt,
        yw1, yw2, yw3,
        rw1, rw3,
        gr1, gr3
      )
      ret.push(
        yz + fast * jk + kd * kt,
        rz + fast * jk + kd * kt,

        yz + fast * jk + kd * kt + yw1,
        yz + fast * jk + kd * kt + yw2,
        yz + fast * jk + kd * kt + yw3,

        rz + fast * jk + kd * kt + rw1,
        rz + fast * jk + kd * kt + rw3,

        rz + fast * jk + kd * kt + gr1,
        rz + fast * jk + kd * kt + gr3
      )

      return ret
    }

    function priceHTML(rows) {
      var str = "";
      str += "<table>";
      for (i = 0; i < rows.length; i++) {
        col = rows[i];
        str += "<tr>\n"
        str += (""
          + "<td class=\"right\">" + ("    " + col[0]).slice(-4) + "-" + ("    " + col[1]).slice(-4) + "</td>\n"
          + "<td class=\"right typeC\">" + col[2] + "</td>\n"
          + "<td class=\"right typeD\">" + col[3].toFixed(1) + "</td>\n"
          + "<td class=\"right typeG\">" + col[4].toFixed(1) + "</td>\n"

          + "<td class=\"right typeK\">" + col[5].toFixed(1) + "</td>\n"
          + "<td class=\"right typeK seat_match\">" + col[6].toFixed(1) + "</td>\n"
          + "<td class=\"right typeZ seat_match\">" + col[7].toFixed(1) + "</td>\n"
          + "<td class=\"right typeD\">" + col[8].toFixed(1) + "</td>\n"
          + "<td class=\"right typeD\">" + col[9].toFixed(1) + "</td>\n"
          + "<td class=\"right typeD\">" + col[10].toFixed(1) + "</td>\n"
          + "<td class=\"right typeG\">" + col[11].toFixed(1) + "</td>\n"
          + "<td class=\"right typeG\">" + col[12].toFixed(1) + "</td>\n"
          + "<td class=\"right typeC\">" + col[13].toFixed(1) + "</td>\n"
          + "<td class=\"right typeC\">" + col[14].toFixed(1) + "</td>\n"

          + "<td class=\"right typeD seat_match\">" + col[15].toFixed(1) + "</td>\n"
          + "<td class=\"right typeG seat_match\">" + col[16].toFixed(1) + "</td>\n"

          + "<td class=\"right typeD\">" + col[17].toFixed(1) + "</td>\n"
          + "<td class=\"right typeD\">" + col[18].toFixed(1) + "</td>\n"
          + "<td class=\"right typeD seat_match\">" + col[19].toFixed(1) + "</td>\n"
          + "<td class=\"right typeG\">" + col[20].toFixed(1) + "</td>\n"
          + "<td class=\"right typeG seat_match\">" + col[21].toFixed(1) + "</td>\n"
          + "<td class=\"right typeC\">" + col[22].toFixed(1) + "</td>\n"
          + "<td class=\"right typeC seat_match\">" + col[23].toFixed(1) + "</td>\n"
        )
        str += "</tr>\n"
      }
      str += "</table>";
      return str;
    }

    function pricetable(up, kd, fast, bxoff) {
      console.log(up, kd, fast, bxoff)
      var rows = []
      var sections = gen_sections()
      for (var i = 0; i < sections.length; i++) {
        var section = sections[i]
        var row = [section.floor + 1, section.ceil, section.center].concat(unionprice(section.center, up, kd, fast, bxoff))
        rows.push(row)
        console.log(row)
      }
      return rows
    }
    setHTML("pricetable", priceHTML(pricetable(0.5, 1, 2, 1)))

  </script>
</body>

</html>