<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
body {
  font-family: "Helvetica Neue", Helvetica, monospace;
  -webkit-text-size-adjust: none;
}

table {
  border-collapse: collapse;
}

td {
  white-space: nowrap;
  word-wrap: keep-all;
  word-break: keep-all;
}

input {
  font-size: 1em;
  width: 30%;
  max-width: 20em;
  padding: 1px;
}

form {
  margin: 0px;
}

pre {
  margin: 0px;
}

.rel {
  position: relative;
}

.abs {
  position: absolute;
}

.stickytop {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  z-index: 2;
}

.right {
  text-align: right;
}

.hide {
  display: none;
}

.typeZ,
.type25T {
  background-color: #004a80;
  color: #ffffff;
}

.typeBSP {
  background-color: #004a80;
  color: #acd2c9;
}

.type25DT {
  background-color: #1445b8;
  color: #c32230;
}

.typeT,
.type25K {
  background-color: #1445b8;
  color: #c32230;
}

.type25Z {
  background-color: #33a6cc;
  color: #ffffff;
}

.typeK,
.typeY,
.type1,
.type2,
.type3,
.type4,
.type5,
.type6,
.type7,
.type8,
.type9,
.type25G,
.type25A {
  background-color: #cc4c33;
  color: #ffffff;
}

.type200J {
  background-color: #29a352;
  color: #e6cc4c;
}

.type200JSG {
  background-color: #29a352;
  color: #ba0c1c;
}

.type200JAD {
  background-color: #e0e8f3;
  color: #415853;
}

.type300AF {
  background-color: #ddddff;
  color: #a80022;
}

.type300BF {
  background-color: #ddddff;
  color: #bf9540;
}

.type400AF {
  background-color: #d4d4d4;
  color: #a80022;
}

.type400BF {
  background-color: #bf9540;
  color: #ffffff;
}

.type400AFZ {
  background-color: #d4d4d4;
  color: #d06301;
}

.type400BFZ {
  background-color: #bf9540;
  color: #fdfc9a;
}

.type400BFC5162 {
  background-color: #1f63a8;
  color: #999999;
}

.type400BFZ0524 {
  background-color: #4b2673;
  color: #d98cb3;
}

.typeCRH {
  background-color: #ffffff;
  color: #3d668f;
}

.typeservice_0 {
  background-color: #567e60;
  color: #fff700;
}

.typeG {
  background-color: #d4d4d4;
  color: #a80022;
}

.typeC {
  background-color: #bf9540;
  color: #ffffff;
}

.typeD,
.typeS {
  background-color: #ffffff;
  color: #3d668f;
}

.double {
  text-decoration-line: underline;
  text-decoration-style: double;
}

.AC380V {
  text-decoration-line: underline;
  text-decoration-style: wavy;
}

.DC600V {
  text-decoration-line: underline;
  text-decoration-style: solid;
}

.ctl {
  color: #999999;
  text-decoration-line: line-through;
  text-decoration-color: #FF0000;
}

#ticket {
  white-space: nowrap;
  word-wrap: keep-all;
  word-break: keep-all;
}

.ticket_full {
  background-color: #569b4c;
  color: #ffffff;
}

.ticket_warn,
.seat_warn.ticket_full {
  background-color: #ef8a3b;
  color: #ffffff;
}

.ticket_hb {
  background-color: #ffffff;
  color: #5697f5;
}

.ticket_out {
  background-color: #ffffff;
  color: #999999;
}

.ticket_discount {
  background-color: #ffffff;
  color: #cc4c33;
}

.ticket_ex {
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 0;
  border-bottom: 8px solid transparent;
  border-left: 8px solid #569b4c;
}


.choice_bed {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 0;
  height: 0;
  border-bottom: 8px solid #1445b8;
  border-left: 8px solid transparent;
}

.seat_match {
  font-weight: bold;
  text-decoration-line: underline;
  text-decoration-color: #cccccc;
  -webkit-text-decoration-color: #cccccc;
}

.weekend {
  color: #ff0000;
  text-decoration: underline #ff0000;
}

.sch {
  margin: 0.5em;
  display: inline-table;
}

.favorite{
  background-color: #00ffffff;
  position:absolute;
  width:280%;
  max-width:25em;
  z-index:3;
  word-break: keep-all;
}

  </style>
  <style title='hide'>
  </style>
</head>

<body>
  <div id="time"></div>
  <span onclick="setValue('date',dateAdd(getValue('date'),-7))">-7</span>
  <span onclick="setValue('date',dateAdd(getValue('date'),-1))">-1</span>
  <input type="date" id="date" style="min-width:8em;max-width:8em" onchange="console.log(this.value)" />
  <span onclick="setValue('date',dateAdd(getValue('date'),1))">+1</span>
  <span onclick="setValue('date',dateAdd(getValue('date'),7))">+7</span>
  <span onclick="setValue('date',dateAdd(timeStr(0, 'yyyy-mm-dd'),14))">+14</span>
  <span id="login" onclick="crqrcheck()">login</span>
  <span id="login_status"></span>
  <form>
    <input type="text" id="keyword" placeholder="车次或站名" style="max-width:10em" onchange="console.log(this.value)" />
    <input name="btn" type="submit" value="查询" style="max-width:4em" onclick="get_search_train_csv(getValue('keyword'));return false;">
    <span onclick="search(getValue('keyword'))">联网查询</span>
    <span onclick="search_emu(getValue('keyword'))">emu</span>
    <span onclick="gettraininfo(getValue('keyword'), getValue('date').replace(/-/g, ''))">info</span>
    <span onclick="getemucar(getValue('keyword'), getValue('date').replace(/-/g, ''))">car</span>
    <span onclick="getemuqrcode(getValue('keyword'))">qr</span>
    <span onclick="gettrainmapline(getValue('keyword'))">line</span>
    <br />
  </form>
  <form>
    <span id="from_station_span" style="position: relative;">
      <input type="text" id="from_station" placeholder="出发站" onkeyup="setInnerHTML('from_tele', telecode(this.value));qss(this.value)" onfocus="setDisplay('favorite_from', '')"/>
      <span id="from_tele" style="position:absolute;right:0.5em;bottom:0em;"></span>
      <div id="favorite_from" class="favorite" style="left:0;top:120%;display:none;">
      </div>
    </span>
    <span onclick="changeFromTo()">&lt;&gt;</span>
    <span id="to_station_span" style="position: relative;">
      <input type="text" id="to_station" placeholder="终到站" onkeyup="setInnerHTML('to_tele',telecode(this.value))" onfocus="setDisplay('favorite_to', '')"/>
      <span id="to_tele" style="position:absolute;right:0.5em;bottom:0em;"></span>
      <div id="favorite_to" class="favorite" style="right:-5em;top:120%;display:none;">
      </div>
    </span>
    <input name="btn" type="submit" value="余票查询" style="max-width:6em" onclick="getlcxxcx(getValue('from_station'),getValue('to_station'), getValue('date'));return false;">
    <br />
  </form>
  <div id="ticket_date">
  </div>
  <div>
    <span onclick="setCssRule('hide','.hideG-,.hideD,.hideC,.hideK{display:none}')">G+ZT</span>
    <span onclick="setCssRule('hide','.hideG,.hideC,.hideK{display:none}')">DZT</span>
    <span onclick="setCssRule('hide','.hideC,.hideK{display:none}')">GDZT</span>
    <span onclick="setCssRule('hide','.hideG,.hideC{display:none}')">DZTK</span>
    <span onclick="setCssRule('hide','.hideG,.hideD,.hideC{display:none}')">ZTK</span>
    <span onclick="setCssRule('hide','.hideG,.hideC,.hideK{display:none}')">DZT</span>
    <span onclick="setCssRule('hide','.hideG,.hideD,.hideC,.hideK{display:none}')">ZT</span>
    <span onclick="setCssRule('hide','')">All</span>
    <span onclick="setInnerHTML('ticket', '');">清除余票</span>
  </div>
  <div id="qss" style="word-break: keep-all;">
  </div>
  <div id="sch"></div>
  <div id="result" style="white-space: nowrap;"></div>
  <div id="ticket"></div>
  <div id="emu" style="white-space: nowrap;"></div>
  <pre id="emucar" style="overflow-x:scroll;white-space: nowrap;"></pre>
  <a href="/archive.htm" target="_blank">历史时刻表</a>
  <a href="/station.htm" target="_blank">车站车次图示</a>
  <a href="/price.htm" target="_blank">票价计算</a>
  <br />
  <br />
  <a href="http://www.gtbyxx.com/wxg/ky/zhengwan.jsp" target="_blank">广铁正晚点</a>
  <a href="http://61.161.203.55/mobile.myweixin.com/FtStationSch.html" target="_blank">沈局时刻表</a>
  <a href="https://ec.95306.cn/gis/inputSearchStationHyzy.html" target="_blank">95306地图</a>
  <br />
  <br />
  <a href="https://www.12306.cn/kfzmpt/lcxxcx/init" target="_blank">旧版余票</a>
  <a href="https://www.12306.cn/kfzmpt/leftTicketPrice/init" target="_blank">旧版票价</a>
  <a href="https://kyfw.12306.cn/kfzmpt/czxx/init" target="_blank">车站车次</a>
  <!--a href="https://kyfw.12306.cn/kfzmpt/bbcx/init" target="_blank">编组</a// -->
  <a href="https://kyfw.12306.cn/otn/resources/js/query/train_list.js?scriptVersion=1.0">train_list.js</a>
  <a href="https://kyfw.12306.cn/otn/resources/js/framework/station_name.js">station_name.js</a>
  <a href="/kyfw.12306.cn/otn/leftTicket/init" target="_blank">余票</a>
  <a href="/www.12306.cn/index/" target="_blank">/www.12306.cn/index/</a>
  <br />

  <a href="https://products.weather.com.cn/yb.html?page=YB&type=YB_TQQS_3D" target="_blank">3日</a>
  <a href="https://products.weather.com.cn/yb.html?page=YB&type=YB_TQQS_10D" target="_blank">10日</a>
  <a href="https://products.weather.com.cn/sk.html?page=YB&type=TY_FST_ER_24H" target="_blank">降水量</a>
  <a href="https://www.openstreetmap.org/" target="_blank">openstreetmap</a>
  <br />

  <!--script src="js/UNICODE2GBK.js" type="text/javascript"></script//-->
  <!--script src="js/station_name.js" type="text/javascript"></script//-->
  <!--script src="js/qss.js" type="text/javascript"></script//-->
  <!--script src="https://kyfw.12306.cn/otn/resources/js/framework/station_name.js" type="text/javascript"></script//-->
  <!--script src="https://kyfw.12306.cn/otn/resources/js/query/train_list.js?scriptVersion=1.0" type="text/javascript"></script//-->
  <script>
// #004080
// #113997
// #cc4c33
// #305030

// #a80022 400AF
// #bf9540 400BF
// #3d668f CRH5A 蓝绿腰线

// #dedbd3 CR200J 白色

function setInnerHTML(id, str) {
  var e = document.getElementById(id);
  e && (e.innerHTML = str);
}

function setValue(id, str) {
  var e = document.getElementById(id);
  e && (e.value = str);
}

function getValue(id) {
  var e = document.getElementById(id);
  return e ? e.value : "";
}

function setDisplay(id, str) {
  var e = document.getElementById(id);
  e.style.display = str;
}

function setCssRule(id, str) {
  for (i = 0; i < document.styleSheets.length; i++) {
    var ss = document.styleSheets[i]
    if (ss.title == id) {
      var j = ss.cssRules.length
      while (j) {
        ss.removeRule(--j)
      }
      ss.insertRule(str)
    }
  }; return false;
}

function getmin(s) {
  var sp = s.split(":")
  return sp[0] * 60 + (sp[1] | 0)
}

function minAdd(s, diff) {
  var t = getmin(s) + (diff | 0)
  if (t > 1440) {
    t -= 1440
  }
  return ("00" + (t / 60 | 0)).slice(-2) + ":" + ("00" + t % 60).slice(-2)
}

function isLeap(y) {
  if (y & 0x03)
    return 0;
  if (y % 400 == 0)
    return 1;
  if (y % 100 == 0)
    return 0;
  return 1;
}

function dateAdd(date, diff) {
  if (typeof (date) != 'string') return ''
  var f = 'yyyy-mm-dd'
  var day_month = new Array(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);

  match = date.match(/(\d+)-(\d+)-(\d+)/)
  if (!match) return ''
  y = Number(match[1])
  m = Number(match[2])
  d = Number(match[3])

  day_month[2 - 1] = 28;
  if (isLeap(y))
    day_month[2 - 1] = 29;

  d += diff
  // console.log(y, m, d)

  while (d > day_month[(m - 1) % 12]) {
    // console.log(m, day_month[(m - 1) % 12])
    d -= day_month[(m - 1) % 12];
    m++;
    // console.log(y, m, d)
    while (m > 12) {
      m -= 12;
      y += 1;
      day_month[2 - 1] = 28;
      if (isLeap(y))
        day_month[2 - 1] = 29;
      // console.log(y, m, d)
    }
  }

  while (d < 1) {
    m--;
    while (m < 1) {
      y -= 1;
      day_month[2 - 1] = 28;
      if (isLeap(y))
        day_month[2 - 1] = 29;
      m += 12;
      // console.log(y, m, d)
    }
    // console.log(m, day_month[(m - 1) % 12])
    d += day_month[(m - 1) % 12];
    // console.log(y, m, d)
  }

  return f
    .replace("yyyy", ('0000' + y).slice(-4))
    .replace("mm", ('00' + m).slice(-2))
    .replace("dd", ('00' + d).slice(-2))
}


function datediff(date1, date0) {
  if (typeof (date1) != 'string') return 0
  if (typeof (date0) != 'string') return 0
  var day_month = new Array(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);

  match = date_ymd(date0).match(/(\d+)-(\d+)-(\d+)/)
  if (!match) return 0
  y = Number(match[1])
  m = Number(match[2])
  d = Number(match[3])

  match1 = date_ymd(date1).match(/(\d+)-(\d+)-(\d+)/)
  if (!match1) return 0
  y1 = Number(match1[1])
  m1 = Number(match1[2])
  d1 = Number(match1[3])

  day_month[2 - 1] = 28;
  if (isLeap(y))
    day_month[2 - 1] = 29;

  cmp = 0
  if (y < y1) {
    cmp = 1
  }
  if (y > y1) {
    cmp = -1
  }
  if (y == y1) {
    if (m < m1) {
      cmp = 1
    }
    if (m > m1) {
      cmp = -1
    }
  }

  while (cmp == 1) {
    d -= day_month[(m - 1) % 12]
    m ++
    while (m > 12) {
      m -= 12;
      y += 1;
      day_month[2 - 1] = 28;
      if (isLeap(y))
        day_month[2 - 1] = 29;
    }
    if (y1 == y && m1 == m) {
      break;
    }
  }

  while (cmp == -1) {
    m--
    while (m < 1) {
      y -= 1;
      day_month[2 - 1] = 28;
      if (isLeap(y))
        day_month[2 - 1] = 29;
      m += 12;
    }
    d += day_month[(m - 1) % 12]
    if (y1 == y && m1 == m) {
      break;
    }
  }

  return d1 - d
}

function weekday(date) {
  if (typeof (date) != 'string') return -1
  match = date.match(/(\d+)-(\d+)-(\d+)/)
  if (!match) return -1
  y = Number(match[1])
  m = Number(match[2])
  d = Number(match[3])

  if (m <= 2) {
    m += 12;
    y -= 1;
  }

  c = y / 100 | 0;
  y = y % 100;

  var w = y + (y / 4 | 0) + (c / 4 | 0) - 2 * c + ((13 * (m + 1)) / 5 | 0) + d - 1;
  while (w < 0) {
    w += 7;
  }
  while (w >= 7) {
    w -= 7;
  }
  return w | 0
}

function timeStr(i, ff) {
  var n = Number(i);
  var f = ff ? ff : "yyyy-mm-dd HH:MM:SS.xxx"
  n > 0x7FFFFFFF ? n *= 1 : n *= 1000;
  var d = n > 0 ? new Date(n) : new Date();
  return f
    .replace("yyyy", ('0000' + d.getFullYear()).slice(-4))
    .replace("mm", ('00' + (d.getMonth() + 1)).slice(-2))
    .replace("dd", ('00' + d.getDate()).slice(-2))
    .replace("HH", ('00' + d.getHours()).slice(-2))
    .replace("MM", ('00' + d.getMinutes()).slice(-2))
    .replace("SS", ('00' + d.getSeconds()).slice(-2))
    .replace("xxx", ('000' + d.getMilliseconds()).slice(-3));
}

function startTime() {
  clearTimeout(this.timeoutId);              //清除上一个定时器
  var that = this;                      //将this关键字移动至本次refresh()执行中

  var d = new Date()
  var yyyy = ('0000' + d.getFullYear()).slice(-4)
  var month = ('00' + (d.getMonth() + 1)).slice(-2);//Date().getMonth() 0,1,2,...,11
  var dd = ('00' + d.getDate()).slice(-2)
  var hh = ('00' + d.getHours()).slice(-2);
  var mm = ('00' + d.getMinutes()).slice(-2);
  var ss = ('00' + d.getSeconds()).slice(-2);
  var xxx = ('000' + d.getMilliseconds()).slice(-3);
  var day = new Date().getDay();//0,1,2,...,6
  var str_day = new Array("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat");
  var day_month = new Array(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);

  day_month[2 - 1] = 28;
  if (isLeap(y))
    day_month[2 - 1] = 29;

  curr_dd = dd - day;
  curr_month = month;
  if (curr_dd < 1) {//fix last Sun
    curr_month--;
    while (curr_month < 1) curr_month += 12;
    curr_dd += day_month[(curr_month - 1)];
  }

  str_week = ""
  for (i = 0; i < 7; i++) {
    str_week += " " + curr_dd;
    curr_dd++;
    while (curr_dd > day_month[(curr_month - 1) % 12]) {
      curr_dd -= day_month[(curr_month - 1) % 12];
      curr_month++;
      curr_month %= 12;
    }
  }

  document.getElementById('time').innerHTML = (yyyy + "-" + month + "-" + dd + " " + hh + ":" + mm + ":" + ss + " " + str_day[day]).fontcolor("#cc0044") + " " + str_week + "<br />";
  this.timeoutId = window.setTimeout(startTime, 100);   //刷新时间
}
//window.onload = startTime

function date_ymd(s) {
  if (s.length == 6) {
    s = '20' + s
  }
  return s.replace(/(\d\d\d\d)(\d\d)(\d\d)/, "$1-$2-$3")
}

function date_yyyymmdd(s) {
  return s.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3")
}

function has_a_day(s) {
  if (s == "") {
    return date
  }

  if (s[0] == '停') {
    return date
  }

  if (s[0] == '!') {
    return date
  }

  if (s[0] == 'b') {
    var t_sp = s.split('&')
    return has_a_day(t_sp.length > 1 ? t_sp[1] : '')
  }

  if (s[0] == '单') {
    var t_sp = s.split('&')
    return has_a_day(t_sp.length > 1 ? t_sp[1] : '')
  }

  if (s[0] == '双') {
    var t_sp = s.split('&')
    return has_a_day(t_sp.length > 1 ? t_sp[1] : '')
  }

  if (s[0] == 'w') {
    var diff = (s[1] | 0) - weekday(date)
    if (diff < 0) {
      diff += 7
    }
    return dateAdd(date, diff)
  }

  //TODO
  if (s.length < 4) {
    return date
  }

  var yyyymmdd = date.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3")
  sp = s.split("|")
  for (i in sp) {
    ssp = sp[i].split("-")
    if (ssp.length) {
      //console.log(ssp[0], ssp[ssp.length-1])
      var tail = ssp[0]
      yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
      var d0 = yyyymmdd
      var tail = ssp[ssp.length - 1]
      yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
      var d1 = yyyymmdd
      //console.log(d0, d1)
      //console.log(d, d0 <= d, d <= d1)
    }
  }

  return yyyymmdd.replace(/(\d\d\d\d)(\d\d)(\d\d)/, "$1-$2-$3")
}

function is_a_day(s, d) {
  // console.log("is_a_day(s, d)", s, d)
  if (s == "") {
    return 1
  }

  if (s[0] == '停') {
    return 1 - is_a_day(s.replace("停", ""), d)
  }

  if (s[0] == '!') {
    return 1 - is_a_day(s.replace("!", ""), d)
  }

  if (s[0] == 'b') {
    var t_sp = s.split('&')
    var t = t_sp[0]
    var diff = datediff(d, graph_yymmdd)
    var c = (t.length-1)
    if (t[c - diff % c] != '1') {
      return 0
    }
    return is_a_day(t_sp.length > 1 ? t_sp[1] : '', d)
  }

  if (s[0] == '单' || s[0] == '双') {
    var t_sp = s.split('&')
    var t = t_sp[0]
    var diff = datediff(d, graph_yymmdd)
    if (diff % 2 != ((s[0] == '单')?1:0) ) {
      return 0
    }
    return is_a_day(t_sp.length > 1 ? t_sp[1] : '', d)
  }

  if (s[0] == 'w') {
    var w = weekday(d.replace(/(\d\d\d\d)(\d\d)(\d\d)/, "$1-$2-$3"))
    if (w == 0) {
      w = 7
    }
    var t_sp = s.split('&')
    var t = t_sp[0]
    if (t.indexOf(w) == -1) {
      return 0
    }
    return is_a_day(t_sp.length > 1 ? t_sp[1] : '', d)
  }

  //TODO
  if (s.length < 4) {
    return 1
  }

  var yyyymmdd = date.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3")
  sp = s.split("|")
  for (i in sp) {
    ssp = sp[i].split("-")
    if (ssp.length) {
      //console.log(ssp[0], ssp[ssp.length-1])
      var tail = ssp[0]
      yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
      var d0 = yyyymmdd
      var tail = ssp[ssp.length - 1]
      yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
      var d1 = yyyymmdd
      //console.log(d0, d1)
      //console.log(d, d0 <= d, d <= d1)
      if (d0 <= d && d <= d1) {
        return 1
      }
    }
  }

  return 0
}

//is_a_day('停200219-200315', '20200314')
//is_a_day('191230-200123|25-0201|03|05-10|12|14|16|18|20|22|24|26|28|0301|03|05|07|09|11|13|15-0414', '2020-03-15')

function ticket_date() {
  holiday = ['2023-12-30', '2023-12-31', '2024-01-01',
    '2024-02-10', '2024-02-11', '2024-02-12', '2024-02-13', '2024-02-14', '2024-02-15', '2024-02-16', '2024-02-17', 
    '2024-04-04', '2024-04-05', '2024-04-06', 
    '2024-05-01', '2024-05-02', '2024-05-03', '2024-05-04', '2024-05-05', 
    '2024-06-08', '2024-06-09', '2024-06-10', 
    '2024-10-01', '2024-10-02', '2024-10-03', '2024-10-04', '2024-10-05', '2024-10-06', '2024-10-07']
  var h = 0
  var html = ''
  var base_date = timeStr(0, "yyyy-mm-dd")
  for (var i = 0; i < 30; i++) {
    cur_date = dateAdd(base_date, i)
    day = weekday(cur_date)
    if (1 << day & 0x41 || holiday.indexOf(cur_date) >= 0) { // 0b1000001
      // console.log(cur_date, day)
      h |= 1 << i
    }
  }

  for (var i = 0; i < 15; i++) { // i<30
    //valid = h | h << 1 | h >> 1 | h >> 2 | 1 << 0 | 1 << 1 | 1 << 29
    cur_date = dateAdd(base_date, i)
    //if (1 << i & valid) {
    html += "<span" + (1 << i & h ? " class=\"weekend\"" : "") + " onclick=\"getTicket(getValue('from_station'),getValue('to_station'), '" + cur_date + "');return false;\">" + cur_date.replace(/(\d{4})[-\/]*(\d{2})[-\/]*(\d{2})/, "$3") + "</span>\n"
    //}
  }
  document.getElementById("ticket_date").innerHTML += html;
}

ticket_date()

window.LeftTicketUrl = "leftTicket/query"; // 余票默认URL
endpoint = "/" // "http://127.0.0.1/"
if (window.location.href.indexOf('github.io') >= 0) {
  endpoint = "http://127.0.0.1/"
}
date = timeStr(0, "yyyy-mm-dd")
setValue("date", date);
graph_yymmdd = '240410'

function getLeftTicketUrl() {
  setInnerHTML("ticket", "start LeftTicketUrl"); //
  var url = 'https://kyfw.12306.cn/otn/leftTicket/init'

  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");

  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        if (typeof (xhr.responseText) != "undefined") {
          var m = xhr.responseText.match("leftTicket/query[^']*")
          if (m) {
            window.LeftTicketUrl = m[0]
          }
        }
        setInnerHTML("ticket", "") //
      } else {
        setInnerHTML("ticket", xhr.status + " " + xhr.statusText); //
      }
    }
  }

  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  setInnerHTML("ticket", "loading LeftTicketUrl"); //
  xhr.send()
}

function getstation() {
  var url = '/js/station.min.csv'

  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");

  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        window.s = []
        if (typeof (xhr.responseText) != "undefined") {
          var s1 = xhr.responseText.split("\n");
          for (var i = 0; i < s1.length; i++) {
            var ss = s1[i];
            if (ss.length > 0) {
              ss = ss.split(",");
              window.s.push(ss);
            }
          }
        }
        setInnerHTML("result", "")
      } else {
        setInnerHTML("result", xhr.status + " " + xhr.statusText);
      }
    }
  }

  xhr.open("GET", url, true);
  setInnerHTML("result", "loading station");
  xhr.send()
}

getstation()


function set_from(name) {
  setValue("from_station", name)
  setInnerHTML('from_tele', telecode(name))
  qss(name)
  setDisplay('favorite_from', 'none')
}

function set_to(name) {
  setValue("to_station", name)
  setInnerHTML('to_tele', telecode(name))
  setDisplay('favorite_to', 'none')
}

function changeFromTo() {
  var from = getValue("from_station");
  var to = getValue("to_station");
  console.log(from, to)
  set_from(to);
  set_to(from);
}


function favorite_station() {
  var fav = `<u><b>哈尔滨</b></u> 佳木斯 牡丹江 齐齐哈尔 海拉尔 加格达奇
<u><b>沈阳</b></u> 大连 丹东 锦州 通辽 <b>长春</b> 吉林 通化 白城
<u><b>北京</b></u>  <b>天津</b> 秦皇岛 德州 <b>石家庄</b> 邯郸 张家口 承德
<b>太原</b> 大同 临汾 运城 <b>呼和浩特</b> 包头 集宁 鄂尔多斯
<u><b>郑州</b></u> 洛阳 新乡 <b>武昌</b> 襄阳 宜昌东 <b>西安</b> 宝鸡 安康
<b>长沙</b> 衡阳 怀化 株洲 石门县北 <b>海口</b> 三亚 湛江
<u><b>广州</b></u> <b>深圳</b> 香港西九龙 韶关 珠海 龙川 梅州 汕头
<b>南京</b> 徐州 连云港 泰州 南通  <b>济南</b> 青岛 烟台 
<u><b>上海</b></u> <b>杭州</b> 金华 温州 宁波 <b>合肥</b> <b>蚌埠</b> 阜阳 安庆
<b>南昌</b> 九江 赣州 鹰潭 上饶 <b>福州</b> <b>厦门</b> 龙岩 三明北
<u><b>成都</b></u> 广元 攀枝花 <b>重庆</b> 内江 达州 <b>贵阳</b> 六盘水
<b>昆明</b> 大理 河口北 西双版纳 <b>柳州</b> 桂林 <b>南宁</b> 金城江
<u><b>兰州</b></u> 武威 嘉峪关 天水 <b>银川</b> 中卫
<b>西宁</b> 格尔木 <b>拉萨</b> 日喀则 林芝
<u><b>乌鲁木齐</b></u>  哈密  奎屯 克拉玛依 库尔勒 喀什 和田
`
  setInnerHTML("favorite_from", fav.replaceAll(/([\S]+)/g, '<span onclick="set_from(this.innerText)">$1</span>').replaceAll("\n", "<br />\n"))
  setInnerHTML("favorite_to", fav.replaceAll(/([\S]+)/g, '<span onclick="set_to(this.innerText)">$1</span>').replaceAll("\n", "<br />\n"))
}

favorite_station()

document.onclick = function(e){
  if (!document.getElementById('from_station_span').contains(e.target)) setDisplay('favorite_from', 'none')
  if (!document.getElementById('to_station_span').contains(e.target)) setDisplay('favorite_to', 'none')
}

function telecode(name) {
  for (var ii in s) {
    if (s[ii][0] === name) {
      return s[ii][1];
    }
  }
  return "";
}

function telename(tele) {
  for (var ii in s) {
    if (s[ii][1] === tele) {
      return s[ii][0];
    }
  }
  return tele || "";
}

function qssbyname(name) {
  for (var ii in s) {
    if (s[ii][0] === name) {
      return s[ii][2];
    }
  }
  return "";
}

function search_qss(str) {
  var c = search_samecity(str)
  ret = ""
  for (i in c) {
    ret += c[i] + ":" + (qssbyname(c[i]) || "") + " "
  }
  document.getElementById("qss").innerHTML = ret;
}

function search_samecity(str) {
  if (!telecode(str)) {
    return
  }
  for (i in window.samecity) {
    for (j in window.samecity[i]) {
      if (window.samecity[i][j] == str) {
        return window.samecity[i] || []
      }
    }
  }
  return [str]
}

function qss(str) {
  if (window.samecity) {
    search_qss(str)
    return
  }
  var url = "samecity.txt"
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        data = xhr.responseText.split("\n");
        window.samecity = []
        for (i in data) {
          if (data[i].length == 0) continue
          window.samecity.push(data[i].replace("\r", "").split(","))
        }

        search_qss(str)
      } else {
        document.getElementById("qss").innerHTML = ret + " " + xhr.status + " " + (xhr.statusText || "error");
      }
    }
  }
  xhr.open("GET", url, true);
  xhr.send();
}


function hash_no(str) {
  str = (str || "").split("/")[0]
  var c = str.charAt(0);
  var offset = {
    "Z": 10000, "T": 20000, "K": 30000,
    "Y": 00000,
    "G": 40000, "D": 50000, "C": 60000,
    "S": 70000,
    "L": 80000, "A": 80000, "N": 80000,
    "P": 10000, "Q": 20000, "W": 30000,
    "V": 01000, "B": 02000, "U": 04000, "X": 05000
  }
  var num = Number(str.replace(/\D+/g, '')) % 10000;
  return (offset[c] || 0) + num;
}
maxlen = 90000

function traintype(code, service) {
  code = code.split("/")[0]
  if (service == '0') {
    return "service_0"
  }
  var key = (hash_no(code)-1)
  if ([6088,6089,6092].indexOf(key / 10 | 0) > -1) {
    return "200JSG"
  }
  if ([500,501,502].indexOf(key / 100 | 0) > -1) { // 507 508 [2019-2024.1.10)
    return "200JAD"
  }
  if ([60].indexOf(key / 1000 | 0) > -1) {
    return "200J"
  }
  // if ('DC'.indexOf(code[0]) > -1 && /^D[78]\d\d$|^C\d{1,3}$/.test(code)) { // /^D[78]\d\d$|^D54\d\d$|^D662[1-8]$|^D663[56]$|^D665[5-8]|^C\d{1,3}$|^C15\d\d$|^C56[5-9]\d$|^C5[78]\d\d$|^C81[0-4]\d$|^C8[34]\d\d$|^C8[56]\d\d$|^C87[2-9]\d$|^C950\d$/
  //   return "200J"
  // }
  return code[0]
}


//Z81 Z80 Z81/0
function multi_train_no(train_no, train_code) {
  var no = train_no.slice(2, 10).replace(/^[0]+/g, "");
  if (no == train_code) {
    return train_code;
  }
  var l = Math.min(no.length, train_code.length);
  var idx = 0;
  for (idx = 0; idx < l; idx++) {
    if (no[idx] != train_code[idx]) {
      break;
    }
  }
  if (idx < train_code.length) {
    return no + "/" + train_code.slice(idx);
  }
  console.log("idx >= train_code.length ",train_no, train_code)
  return no;
}

function search_train_csv(kw) {
  var result = "";
  // var re = new RegExp(str, "i");
  //document.getElementById("sch").innerHTML = "";
  var sp = kw.split("-")
  var minkey = hash_no(sp[0]) - 1
  var maxkey = minkey
  if (sp.length > 1) {
    if (sp[1].length < sp[0].length) {
      sp[1] = sp[0].slice(0, sp[0].length -sp[1].length) + sp[1]
    }
    maxkey = hash_no(sp[1]) - 1
  }
  if (kw == '') {
    minkey = 0
    maxkey = window.train.length - 1
  }
  for (var key = minkey; key <= maxkey; key++) {
    for (i in window.train[key]) {
      t = window.train[key][i];
      //if (re.test(t.train_code)) { // if(t.train_code.includes(str)) { // 
      var is_run = is_a_day(t.date, date.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3"))
      result += ("<div id=\"" + t.train_code + "\">"
        + t.train_no + " " + t.from_station + " " + t.to_station
        + " " + "<span class=\"type" + traintype(t.train_code, t.service_type) + "\" onclick=\"get_search_time_csv('" + t.train_no.slice(2, 10).replace(/^[0]+/g, "") + "')\">"
        + t.train_code // multi_train_no(t.train_no, t.train_code)
        + "</span>" + " " + (telename(t.from_station) || "---") + " " + (telename(t.to_station) || "---")
        + " " + emu_by_code(t.train_code)
        // + " " + t.service_type
        + " " + "<span class=\"" + (is_run ? "" : "ctl") + "\">" + t.date + "</span>"
        //+ " " + "<a href=" + schurl + " target='_blank'>" + multi_train_no(t.train_no, t.train_code) + "</a>" 
        + "</div>"
      );
      //if (is_run && t.train_code == str.toUpperCase()) {
      // document.getElementById("sch").innerHTML = t.train_code + "<br />\n";

      //}
      //}
    }
  }
  get_search_time_csv(kw);
  document.getElementById("result").innerHTML = result;
}

function get_search_train_csv(str) {
  if (window.train) {
    search_train_csv(str)
    return
  }
  var url = "js/train" + graph_yymmdd + ".csv"
  document.getElementById("result").innerHTML = str
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onprogress = function (ev) {
    document.getElementById("result").innerHTML = str + " " + ev.loaded
  }
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        data = xhr.responseText.split("\n");
        window.train = Array(maxlen)
        for (var i = 0; i < maxlen; i++) {
          window.train[i] = []
        }
        for (i in data) {
          var row = data[i].split(",");
          if (row.length <= 3) continue
          var key = hash_no(row[0].slice(2, 10).replace(/^0+/g, '')) - 1
          if (key < 0 || key >= maxlen) {
            key = maxlen - 1
          }
          window.train[key].push({
            train_no: row[0] || "",
            from_station: row[1] || "",
            to_station: row[2] || "",
            train_code: multi_train_no(row[0], row[3]),
            total_num: row[4] || "",
            service_type: row[5] || "", // (row[5].length & row[5] == '0') ? "无空调" : "",
            date: row[6] || "",
            // src: row[7] || "",
          })
        }

        search_train_csv(str)
      } else {
        document.getElementById("result").innerHTML = str + " " + xhr.status + " " + (xhr.statusText || "error");
      }
    }
  }
  xhr.open("GET", url, true);
  //xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}

function search_time_csv(kw) {
  if (kw == "") {
    return
  }
  var sp = kw.split("-")
  var minkey = hash_no(sp[0]) - 1
  var maxkey = minkey
  if (sp.length > 1) {
    if (sp[1].length < sp[0].length) {
      sp[1] = sp[0].slice(0, sp[0].length -sp[1].length) + sp[1]
    }
    maxkey = hash_no(sp[1]) - 1
  }
  var str = "";
  for (var key = minkey; key <= maxkey; key++) {
    sch = window.timetable[key]
    if (!sch || sch.length == 0) {
      continue
    }
    for (i in sch) {
      if (i == 0 || sch[i].arr_time == "") {
        if (i > 0) {
          str += "</div>"
        }
        if (!window.train[key]) {
          continue;
        }
        var t = window.train[key][0]
        for (var idx in window.train[key]) {
          if (window.train[key][idx].date == sch[i].date) {
            t = window.train[key][idx]
            break
          }
        }
        str += ("<div class=\"sch\" id=\"sch_" + t.train_code + "\"><div><span class=\"type"
          + traintype(t.train_code, t.service_type) + "\">"
          + t.train_code
          + "</span> " + telename(t.from_station) + " " + telename(t.to_station) + " " + t.date + " " + emu_by_code(t.train_code)
          + "</div>\n");
      }

      str += ("<div id=\"" + sch[i].station + "_" + sch[0].train_code + "\">"
        + telename(sch[i].station) + " "
        + sch[i].arr_time + " "
        + sch[i].dep_time + " "
        //+ sch[i].stopover_time + " "
        + ((i > 0 && sch[i].arr_day_diff && sch[i].arr_day_diff != sch[i - 1].arr_day_diff) ? "+" + sch[i].arr_day_diff : "") + " "
        // + ((i == 0) ? "" : (" <span id=\"" + telename(sch[i].station) + "_" + sch[0].train_code + "_0\" onclick=\"getzwdcx_id(this.id)\">到</span>"))
        // + ((i == sch.length - 1) ? "" : (" <span id=\"" + telename(sch[i].station) + "_" + sch[0].train_code + "_1\" onclick=\"getzwdcx_id(this.id)\">发</span>"))
        + "</div>\n");
    }
    str += "</div>"
  }
  setInnerHTML("sch", str + document.getElementById("sch").innerHTML);
}

function get_search_time_csv(str) {
  if (window.timetable) {
    search_time_csv(str)
    return
  }
  var url = "js/time" + graph_yymmdd + ".min.csv"
  //document.getElementById("sch").innerHTML = str
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onprogress = function (ev) {
    document.getElementById("sch").innerHTML = str + " " + ev.loaded
  }
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        document.getElementById("sch").innerHTML = ""
        data = xhr.responseText.split("\n");
        window.timetable = Array(maxlen)
        for (var i = 0; i < maxlen; i++) {
          window.timetable[i] = []
        }
        var train_code = ""
        var arr_time = ""
        var dep_time = ""
        var day_diff = ""
        for (var i in data) {
          var row = data[i].split(",");
          if (row.length <= 1) continue
          if (row[3]) {
            train_code = row[3] || ""
            day_diff = ""
          }
          if (row[4]) {
            day_diff = row[4] || ""
          }
          if (!row[1]) {
            arr_time = ""
            dep_time = row[2] || ""
          } else {
            arr_time = minAdd(dep_time, row[1])
            dep_time = row[2] ? minAdd(arr_time, row[2]) : ""
          }
          var key = hash_no(train_code) - 1
          if (key < 0 || key >= maxlen) {
            key = maxlen - 1
          }
          window.timetable[key].push({
            train_code: row[3] || "",
            station: row[0] || "",
            // station_no: "",
            arr_day_diff: day_diff,
            arr_time: arr_time,
            dep_day_diff: day_diff,
            dep_time: dep_time,
            date: row[5] || "",
          })

          /*
          station: row[0] || "",
          station_no: row[1] || "",
          arr_day_diff: row[2] || "",
          arr_time: row[3] || "",
          dep_day_diff: row[4] || "",
          dep_time: row[5] || "",
          distance: row[6] || "",
          speed: row[7] || "",
          */
        }

        search_time_csv(str)
      } else {
        document.getElementById("sch").innerHTML = str + " " + xhr.status + " " + (xhr.statusText || "error");
      }
    }
  }
  xhr.open("GET", url, true);
  xhr.send();
}


function getTicket(from, to, date) {
  var from_station_telecode = telecode(from);
  var to_station_telecode = telecode(to);
  if (!from_station_telecode) {
    return;
  }
  if (!to_station_telecode) {
    return;
  }
  //成人ADULT 学生0X00
  var url = "https://kyfw.12306.cn/otn/" + window.LeftTicketUrl
    + "?leftTicketDTO.train_date=" + date
    + "&leftTicketDTO.from_station=" + from_station_telecode
    + "&leftTicketDTO.to_station=" + to_station_telecode + "&purpose_codes=ADULT";
  var id = date + "_" + from_station_telecode + "_" + to_station_telecode;
  if (!document.getElementById(id)) {
    document.getElementById("ticket").innerHTML =
      "<div id=\"" + id + "\">"
      + date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
      + "</div>\n" + document.getElementById("ticket").innerHTML;
  }
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        var j = JSON.parse(xhr.responseText);
        if (!j.status) {
          window.LeftTicketUrl = j.c_url || window.LeftTicketUrl;
        }
        document.getElementById(id).innerHTML =
          "<div class=\"stickytop ticket_hb\">"
          + date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
          + "</div>\n<div style=\"overflow-x:scroll;\">"
          + " center: " + xhr.getResponseHeader("center") + " X-Via: " + xhr.getResponseHeader("X-Via")
          + ticketHTML(j.data.result, j.data.map, date);
        + "</div>"
      } else {
        document.getElementById(id).innerHTML =
          date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
          + " " + xhr.status + " " + (xhr.statusText || "error");
      }
      if ([302].indexOf(xhr.status) > -1) {
        var j = JSON.parse(xhr.responseText);
        if (!j.status) {
          window.LeftTicketUrl = j.c_url || window.LeftTicketUrl;
          getTicket(from, to, date)
        }
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}

var class_map = {
  "6": 21,
  "A": 21,

  "Q": 22, // 400BF-C多功能座 ?20
  "5": 22, // other
  "H": 22, // other
  "B": 22, // other
  "C": 22, // other
  "E": 22, // other
  "K": 22, // other
  "L": 22, // other

  "I": 23, // 
  "4": 23,

  "7": 31, //24
  "2": 24,

  "P": 25,
  "WZ": 26,
  "S": 30,//纵向2E二等包座 //27, // ?
  "J": 28,
  "3": 28,

  "8": 30, // 29
  "1": 29,

  "O": 30,
  "M": 31,
  "9": 32,
  "F": 33,
}

var h = [
  "secretStr", //0
  "按钮",
  "车次号",
  "车次", // 3
  "始发",
  "终到",
  "出发", // 6
  "到达", // 7
  "发时",
  "到时",
  "历时", //10
  "可以购买", // Y/N/IS_TIME_NOT_BUY
  "12",   // yp_info decodeURIComponent base64 crypt
  "始发日",
  ".",   //train_seat_feature
  "15",   //location_code
  "发#",  //16
  "到#",  //17
  "证", //18
  "ctl",  //19
  "gg",   //20 gg_num ?Q观光座
  "GR",   //21 6 高级软卧 //A D954 高级动卧
  "其他", //22 5 K23 K3 包厢硬卧  //H T31 一人软包 //K9686 一人软包 //old22 A D954 高级动卧
  "RW",   //23 4 软卧 // D7xx 一等卧
  "RZ",   //24 2 软座
  "ZT",   //25 P 特等 CRH3
  "无",   //26 1|2|O 无座
  "yb",   //27 ?S一等包座
  "YW",   //28 3 硬卧 // D7xx 二等卧
  "YZ",   //29 1 硬座
  "ZE",   //30 O 二等座 //O D7xx 二等座 //S二等包座 D2341-8纵卧代座
  "ZY",   //31 M 一等座
  "ZS",   //32 9 商务座
  "WY",   //33 F (纵向)动卧 D311
  "打折", //34 打折 10401031
  "席别", //35
  "兑",   //36 exchange_train_flag 兑换
  "候补", //37 houbu_train_flag 候补
  "停止候补", //38 houbu_seat_limit 不能候补席别
  "yp_info_cover", //39
  "", //40 0 可以买 2@列车停运 2@列车运行图调整,暂停发售 4@10@ 10点起售 4@12@30@ 12点30分起售 5@11@17@8@ 11月17日 8点起售
  "",
  "",
  "",
  "",
  "", //45 1
  "种类", // 46 dw_flag 智能动车组标志 is_zndcz  201027 智能动车组+复兴号标志 zhi+fu
  "",
  "", // 48
  "", // 49 CHN,CHN CHN,LAO
  "", // 50 到时 当地时间 202401181634
  "", // 51 发时 当地时间 202401180808 
  "", // 52 add_info N#N#
  "", // 53 bed_level_info 
  "", // 54 seat_discount_info
  "", // 55 ? 起售
]

var hkey = [
  "secretStr", //0
  "buttonTextInfo",
  "train_no",
  "station_train_code",
  "start_station_telecode",
  "end_station_telecode",
  "from_station_telecode",
  "to_station_telecode",
  "start_time",
  "arrive_time",
  "lishi", //10
  "canWebBuy", // Y/N/IS_TIME_NOT_BUY
  "yp_info",
  "start_train_date",
  "train_seat_feature",   //train_seat_feature
  "location_code",   //location_code
  "from_station_no",  //16
  "to_station_no",  //17
  "is_support_card", //18
  "controlled_train_flag",  //19
  "gg_num",   //20 gg_num ?Q观光座
  "gr_num",   //21 6 高级软卧 //A D954 高级动卧
  "qt_num", //22 5 K23 K3 包厢硬卧  //H T31 一人软包 //K9686 一人软包 //old A D954 高级动卧
  "rw_num",   //23 4 软卧 // D7xx 一等卧
  "rz_num",   //24 2 软座
  "tz_num",   //25 P 特等 CRH3
  "wz_num",   //26 1|2|O 无座
  "yb_num",   //27 ?S一等包座
  "yw_num",   //28 3 硬卧 // D7xx 二等卧
  "yz_num",   //29 1 硬座
  "ze_num",   //30 O 二等座 //O D7xx 二等座 //S二等包座 D2341-8纵卧代座
  "zy_num",   //31 M 一等座
  "swz_num",  //32 9 商务座
  "srrb_num", //33 F (纵向)动卧 D311
  "yp_ex",    //34 打折 10401031
  "seat_types", //35 席别
  "exchange_train_flag",//36 exchange_train_flag 兑换
  "houbu_train_flag",   //37 houbu_train_flag 候补
  "houbu_seat_limit",    //38 houbu_seat_limit 不能候补席别
  "yp_info_cover",//39 yp_info app叫yp_info_cover
  "yp_info_coverFlag", //40 app叫yp_info_coverFlag?
  "",
  "",
  "",
  "",
  "eticket_train_flag", //45
  "dw_flag", //46
  /*
  0 5 智能 6 澜沧号? 1广深城际? 2动卧?
  1 1 复
  2 Q03 静
  3?      S 智能商务座 ?  S和Z不一定一起出现
  4 a 不能候补标志变x .icon-error Z99   x 调图不能候补
  5 D 動感號
  6 选铺席别
  */
  "",
  "stopcheckTime", //48
  "country_flag", //49
  "local_arrive_time", //50
  "local_start_time",  //51
  "add_info", // 52 ?
  "bed_level_info", // 53 bed_level_info 上中下铺价格 3303045 3103255 3203155 4304765 4104975
  "seat_discount_info", // 54 seat_discount_info 打折折扣 I3076 I1075 J3076 J1076 J2076 O0075 W0075
]

function is_sleeper(s, e, d) {
  //s (5)8-24
  //e 6-22(25)
  if (d <= "02:00") {
    return 0 // "12OMPS87E3456FAJI short"
  }
  if (d >= "20:00") {
    return 1 // "3456FAJI12OMPS87E long"
  }
  if (s >= e && e >= "02:00") {
    return 1 // "3456FAJI12OMPS87E"
  }
  if (s < e && (s <= "04:00")) {
    return 1 //"3456FAJI12OMPS87E night"
  }
  return 0 //"12OMPS87E3456FAJI other"
}
/*
//test
console.log(is_sleeper("12:00","05:00","41:00"), 3)
console.log(is_sleeper("18:00","06:00","36:00"), 3)
console.log(is_sleeper("20:00","06:00","10:00"), 3)
console.log(is_sleeper("20:00","11:00","15:00"), 3)
console.log(is_sleeper("19:00","06:00","11:00"), 3)
console.log(is_sleeper("22:00","12:00","14:00"), 3)
console.log(is_sleeper("16:00","10:00","18:00"), 3)
console.log(is_sleeper("23:00","06:00","07:00"),3)
console.log(is_sleeper("01:00","13:00","12:00"),3)
console.log(is_sleeper("05:00","24:00","19:00"),1)
console.log(is_sleeper("18:00","01:00","07:00"),1)
console.log(is_sleeper("08:00","04:00","10:00"),3)
console.log(is_sleeper("23:00","03:00","04:00"),3)
console.log(is_sleeper("23:00","04:00","05:00"),3)
console.log(is_sleeper("01:00","05:00","04:00"),3)
console.log(is_sleeper("04:00","05:00","01:00"),1)
*/

function hbc(col, cc) {
  for (var i in cc) {
    var c = cc[i];
    var n = class_map[c] || 22;
    var s = col[n];
    if (col[35].indexOf(c) == -1) {
      continue;
    }
    if (s == '') {
      continue;
    }
    if (s == '--') {
      continue;
    }
    if (s == '有' || s > 20) {
      return "ticket_full"
    }
    if (s == '无') {
      if (col[37] > 0 && col[38] != "null" && col[38].indexOf(c) == -1) return "ticket_hb";
      return "ticket_out"
    }
    if (s >= 0 || s <= 20) {
      return "ticket_warn"
    }
  }
  return "ticket_out"
}

function hb(col, cc) {
  for (var i in cc) {
    var c = cc[i];
    var n = class_map[c] || 22;
    var s = col[n];
    if (col[35].indexOf(c) == -1) {
      continue;
    }
    if (s == '') {
      continue;
    }
    if (s == '--') {
      continue;
    }
    if (s == '有') {
      return s
    }
    if (s == '无') {
      if (col[37] > 0 && col[38] != "null" && col[38].indexOf(c) == -1) return "候";
      return s;
    }
    if (s >= 0) {
      return s
    }
  }
  return ""
}

function hbc2(col, cc) {
  for (var i in cc) {
    var c = cc[i];
    var n = hkey[class_map[c] || 22] || 'qt_num';
    var s = col[n];
    if (col['seat_types'].indexOf(c) == -1) {
      continue;
    }
    if (s == '') {
      continue;
    }
    if (s == '--') {
      continue;
    }
    if (s == '有' || s > 20) {
      return "ticket_full"
    }
    if (s == '无') {
      if (col['houbu_seat_limit'] != undefined && col['houbu_seat_limit'] != "null" && col['houbu_seat_limit'].indexOf(c) == -1) return "ticket_hb";
      return "ticket_out"
    }
    if (s >= 0 || s <= 20) {
      return "ticket_warn"
    }
  }
  return "ticket_out"
}

function hb2(col, cc) {
  for (var i in cc) {
    var c = cc[i];
    var n = hkey[class_map[c] || 22] || 'qt_num';
    var s = col[n];
    if (col['seat_types'].indexOf(c) == -1) {
      continue;
    }
    if (s == '') {
      continue;
    }
    if (s == '--') {
      continue;
    }
    if (s == '有') {
      return s
    }
    if (s == '无') {
      // col['houbu_train_flag'] > 0 && 
      if (col['houbu_seat_limit'] != undefined && col['houbu_seat_limit'] != "null" && col['houbu_seat_limit'].indexOf(c) == -1) return "候";
      return s;
    }
    if (s >= 0) {
      return s
    }
  }
  return ""
}


function pricefont(str) {
  return str.replaceAll(/(\.[0])/g, '<span style="color:#fff0;font-size:8px;">$1</span>').replaceAll(/(\.[5])/g, '<span style="font-size:8px;">$1</span>')
}

function ticketprice(str, cc) {
  if (typeof (str) != "string") {
    return ""
  }
  for (var ii in cc) {
    var c = cc[ii];
    for (var i = 0; i + 9 < str.length; i += 10) {
      if (c == str[i]) {
        return pricefont(str.slice(i + 1, i + 5).replace(/^[0]{1,3}/, "") + "." + str.slice(i + 5, i + 6))
      }
    }
  }
  return ""
}

function choicebed(str, cc) {
  if (typeof (str) != "string") {
    return false
  }
  for (var ii in cc) {
    var c = cc[ii];
    if (str.indexOf(c) > -1) {
      return true
    }
  }
  return false
}

function pricebed(str, cc) {
  if (typeof (str) != "string") {
    return ""
  }
  var ret = []
  for (var ii in cc) {
    for (var j=1; j<=3; j++) {
      var c = cc[ii] + j;
      for (var i = 0; i + 1 < str.length; i += 7) {
        if (c == str.slice(i, i + 2)) {
          ret.push(str.slice(i + 2, i + 6).replace(/^[0]{1,3}/, "") + "." + str.slice(i + 6, i + 7))
        }
      }
    }
  }
  return pricefont(ret.join("/"))
}

function ticketdiscount(str, cc) {
  if (typeof (str) != "string") {
    return ""
  }
  var ret = []
  for (var ii in cc) {
    var ret1 = []
    for (var j=0; j<=1; j++) { // 0...3
      var c = cc[ii] + j;
      for (var i = 0; i + 1 < str.length; i += 5) {
        if (c == str.slice(i, i + 2)) {
          ret1.push(str.slice(i + 2, i + 4).replace(/^[0]{1,3}/, "") + "." + str.slice(i + 4, i + 5))
          break
        }
      }
    }
    if (ret1 && ret1.length) {
      ret.push(cc[ii] + " " + (ret1.join("/") || "10"))
    }
  }
  return ret.join(" ")
}

function ticketdiscountex(str, cc) {
  if (typeof (str) != "string") {
    return ""
  }
  for (var i in cc) {
    var c = cc[i];
    for (var i = 0; i + 1 < str.length; i += 2) {
      if (c == str[i]) {
        dis = str.slice(i + 1, i + 2)
        if (dis == '1') {
          return ' ticket_discount'
        }
        if (dis == '0') {
          return ''
        }
      }
    }
  }
  return ""
}


function ticketHTML(result, map, date) {
  var str = "";
  str += "<table>";
  str += (
    "<tr>\n"
    + "<td class=\"abs\" title=\"" + h[2] + "\" width='48px'>" + h[3] + "</td>\n"
    + "<td title=\"" + h[2] + "\" width='48px'>" + h[3] + "</td>\n"
    + "<td title=\"22 " + h[22] + "\">" + " " + "</td>\n"
    + "<td title=\"21|32|20|25 " + h[21] + "/" + h[32] + "/" + h[20] + "/" + h[25] + "\">" + "6" + "</td>\n"
    + "<td title=\"23|27 " + h[23] + "/" + h[27] + "\">" + "4" + "</td>\n"
    + "<td title=\"28|33 " + h[28] + "/" + h[33] + "\">" + "3" + "</td>\n"
    + "<td title=\"24|31 " + h[24] + "/" + h[31] + "\">" + "2" + "</td>\n"
    + "<td title=\"29|30 " + h[29] + "/" + h[30] + "\">" + "1" + "</td>\n"
    // + "<td title=\"26\">" + h[26] + "</td>\n"
    + "<td title=\"" + h[16] + "\">" + h[8] + "</td>\n"
    + "<td title=\"" + h[17] + "\">" + h[9] + "</td>\n"
    + "<td>" + "站" + "</td>\n"
    + "<td>" + h[10] + "</td>\n"
    + "<td>" + "票价" + "</td>\n"
    + "<td title=\"" + h[6] + "\">" + h[6] + "</td>\n"
    + "<td title=\"" + h[7] + "\">" + h[7] + "</td>\n"
    + "<td title=\"" + h[4] + "\">" + h[4] + "</td>\n"
    + "<td title=\"" + h[5] + "\">" + h[5] + "</td>\n"
    + "<td>" + "软" + "</td>\n"
    + "<td>" + "硬" + "</td>\n"
    + "<td title=\"yp_ex\">" + h[34] + "</td>\n"
    + "<td title=\"seat_types\">" + h[35] + "</td>\n"
    + "<td>" + h[13] + "</td>\n"
    + "<td title=\"train_seat_feature\">" + h[14] + "</td>\n"
    + "<td title=\"location_code\">" + h[15] + "</td>\n"
    + "<td>" + h[18] + "</td>\n"
    + "<td>" + h[46] + "</td>\n"
    + "<td>" + "车型" + "</td>\n"
    + "<td title=\"" + h[0] + "\n" + h[12] + "\">" + h[1] + "|" + h[11] + "</td>\n"
    + "</tr>\n"
  );
  var min = 99;
  for (i = 0; i < result.length; i++) {
    col = result[i].split("|");
    var a = (col[17] - col[16]);
    if (a < min && (col[3][0] == 'G')) {
      min = a;
    }
  }
  for (i = 0; i < result.length; i++) {
    col = result[i].split("|");
    sleeper = is_sleeper(col[8], col[9], col[10]);
    dw = col[46].split("#") // 46 dw_flag
    trid = "tr_"+col[6]+"_"+col[7]+"_"+date+"_"+col[3]
    absemu = ("<span class=\"rel\">-<div class=\"abs\" style=\"top:0;right:0;\">" + (emu_short_by_code(col[2].slice(2, 10).replace(/^[0]+/g, "")) || ((dw[5] || '').substring(0, 1) == "D" ? "MTR" : "") || (dw[0] == "5" ? "智" : "") || (dw[1] == "1" ? "复" : "")) + "</div></span>");
    str += (
      "<tr id=\""+trid+"\" class=\"" + "hide" + col[3][0] + (col[19] > 0 ? " ctl" : "") + (((col[3][0] == 'G') && ((col[17] - col[16]) > min + 1)) ? " hideG-" : "") + "\">\n"
      + "<td onclick=\"getcrleftraw('"+result[i]+"', '"+date+"', '"+trid+"')\" class=\"abs type" + traintype(col[3], col[14]) + (col[19] > 0 ? " ctl" : "") + "\" title=\"" + col[2] + "\">" + col[3] + (col[36] > 0 ? "<div class=\"ticket_ex\"></div>" : "") + "</td>\n"
      + "<td class=\"type" + traintype(col[3], col[14]) + (col[19] > 0 ? " ctl" : "") + "\" title=\"" + col[2] + "\">" + col[3] + "</td>\n"
      + "<td class=\"right " + hbc(col, 'QH5LCKB0') + "\">" + (hb(col, 'QH5LCKB0') || col[26] || "-") + "</td>\n"
      + "<td class=\"right " + hbc(col, '6A9PQE') + "\">" + (hb(col, '6A9PQE') || ((hb(col, '1OS82M7')&&hb(col, '3FJ4I')&&!hb(col, 'QH5LCKB0'))?absemu:"") || "-") + "</td>\n"
      + "<td class=\"rel right " + hbc(col, '4I') + "\">" + (hb(col, '4I') || "-") + (choicebed(dw[6], '4I') ? "<div class=\"choice_bed\"></div>" : "") + "</td>\n" // ?S
      + "<td class=\"rel right " + hbc(col, '3FJ') + (sleeper ? " seat_match" : "") + "\">" + (hb(col, '3FJ') || (hb(col, '4I')?"":absemu) || "-") + (choicebed(dw[6], '3FJ') ? "<div class=\"choice_bed\"></div>" : "") + "</td>\n"
      + "<td class=\"right " + hbc(col, '2M7') + "\">" + (hb(col, '2M7') || "-") + "</td>\n"
      + "<td class=\"right " + hbc(col, '1OS8') + (!sleeper ? " seat_match" : " seat_warn") + "\">" + (hb(col, '1OS8') || (hb(col, '3FJ4I')&&!hb(col, '2M7')?absemu:"") || "-") + "</td>\n"
      // + "<td class=\"right\" style=\"font-weight: lighter;\">" + (col[26] || "-") + "</td>\n"
      + "<td title=\"" + col[16] + "\">" + col[8] + "</td>\n"
      + "<td title=\"" + col[17] + "\">" + col[9] + "</td>\n"
      + "<td class=\"right\" onclick=\"getSch(schURL('" + col[2] + "','" + col[4] + "','" + col[5] + "','" + col[13] + "'))\">" + (col[17] - col[16]) + "</td>\n"
      + "<td>" + col[10] + "</td>\n"
      + "<td title=\"" + col[39].replaceAll(/([\W\w]{10})/g,'$1\n') + "\" class=\"right " + ticketdiscountex(col[34], (sleeper ? "3456FAJI12OMPS87E" : "12OMPS87E3456FAJI")) + "\">" + ticketprice(col[39], (sleeper ? "3456FAJI12OMPS87E" : "12OMPS87E3456FAJI")) + "</td>\n"
      + "<td title=\"" + col[6] + "\">" + map[col[6]] + "</td>\n"
      + "<td title=\"" + col[7] + "\">" + map[col[7]] + "</td>\n"
      + "<td title=\"" + col[4] + "\">" + telename(col[4]) + "</td>\n"
      + "<td title=\"" + col[5] + "\">" + telename(col[5]) + "</td>\n"
      + "<td class=\"right\">" + pricebed(col[53], '4I') + "</td>\n" // + " " + pricebed(col[53], '6A').replaceAll(/\.[05]/g, '')
      + "<td class=\"right\">" + pricebed(col[53], '3FJ') + "</td>\n"
      + "<td>" + ticketdiscount(col[54], (sleeper ? "3456FAJI12OMPS87E" : "12OMPS87E3456FAJI")) + "</td>\n" // col[34] + " " + 
      + "<td>" + col[35] + "</td>\n"
      + "<td>" + col[13] + "</td>\n"
      + "<td>" + col[14] + "</td>\n"
      + "<td>" + col[15] + "</td>\n"
      + "<td>" + col[18] + "|" + col[45] + "</td>\n"
      + "<td>" + col[46] + " " + (dw[0] == "5" ? "智" : "") + (dw[1] == "1" ? "复" : "") + ((dw[2] || '').substring(0, 1) == "Q" ? "静" : "") + (dw[5] == "D" ? "動感號" : "") + (dw[6] && dw[6] != "z" ? "铺" : "") + "</td>\n"
      + "<td>" + emu_by_code(col[2].slice(2, 10).replace(/^[0]+/g, "")) + (dw[5] && dw[5].substring(0, 1) == "D" ? "MTR" : "") + "</td>\n"
      + "<td title=\"secretStr " + decodeURIComponent(col[0]) + "\nyp_info " + decodeURIComponent(col[12]) + "\">" + col[1].replace(/<[^>]+>/g, " ") + "|" + col[11] + "|" + col[40] + "</td>\n" //  + "|" + decodeURIComponent(col[12]).replaceAll(/=+$/g,'').length/4*3 + ' ' + col[12]
      + "</tr>\n"
    );

    console.log(
      //col[1] + "\t|" + 
      col[2] + "|" +
      (col[18] > 0 ? col[18] : " ") + "|" +
      col[4] + "|" +
      col[5] + "|" +
      col[16] + "|" +
      col[6] + "|" +
      col[17] + "|" +
      col[7] + "|" +
      col[8] + "|" +
      col[9] + "|" +
      col[10] + "|" +
      col[11] + "|" +
      col[13] + "|" +
      col[14] + "|" +
      col[15] + "|" +
      col[19] + "|" +
      col[20] + "\t|" +
      col[21] + "\t|" +
      col[22] + "\t|" +
      col[23] + "\t|" +
      col[24] + "\t|" +
      col[25] + "\t|" +
      col[26] + "\t|" +
      col[27] + "\t|" +
      col[28] + "\t|" +
      col[29] + "\t|" +
      col[30] + "\t|" +
      col[31] + "\t|" +
      col[32] + "\t|" +
      col[33] + "\t|" +
      col[3] + "\t|" +
      col[46] + "\n" +
      col[38] + "\t|" +
      col[41] + "\t|" +
      col[42] + "\t|" +
      col[43] + "\t|" +
      col[44] + "\t|" +
      col[45] + "\t|" +
      col[47] + "\t|" +
      col[48] + "\t|" +
      col[49] + "|" +
      col[50] + "\t|" +
      col[51] + "\t|" +
      col[52] + "\t|" +
      col[55] + "\t|" +
      col[56] + "\t|" +
      col[36] + "|" +
      col[37] + "|" +
      col[35] + "|" +
      col[34] + "|" +
      col[39] + "|" +
      col[53] + "|" +
      col[54] + "|" +
      col[40]// + "\t|" + 
      //col[0] + "\t|" + 
      //col[12] + "\t|" + 
      //col[36]
    );
  }
  str += "</table>";
  return str;
}


// https://www.12306.cn/kfzmpt/lcxxcx/init
function getlcxxcx(from, to, date) {
  var from_station_telecode = telecode(from);
  var to_station_telecode = telecode(to);
  if (!from_station_telecode) {
    return;
  }
  if (!to_station_telecode) {
    return;
  }
  //成人ADULT 学生0X00
  var url = "https://www.12306.cn/kfzmpt/lcxxcx/query?purpose_codes=ADULT&queryDate=" + date
    + "&from_station=" + from_station_telecode
    + "&to_station=" + to_station_telecode;
  var id = date + "_" + from_station_telecode + "_" + to_station_telecode;
  if (!document.getElementById(id)) {
    document.getElementById("ticket").innerHTML =
      "<div id=\"" + id + "\">"
      + date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
      + "</div>\n" + document.getElementById("ticket").innerHTML;
  }
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        var j = JSON.parse(xhr.responseText);
        if (j.data.flag == false) {
          document.getElementById(id).innerHTML =
            date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
            + " " + j.data.message;
        }
        document.getElementById(id).innerHTML =
          "<div class=\"stickytop ticket_hb\">"
          + date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
          + "</div>\n<div style=\"overflow-x:scroll;\">"
          + " X-Via: " + xhr.getResponseHeader("X-Via")
          + lcxxcxHTML(j.data.datas);
        + "</div>"
      } else {
        document.getElementById(id).innerHTML =
          date + " " + telename(from_station_telecode) + " " + telename(to_station_telecode)
          + " " + xhr.status + " " + (xhr.statusText || "error");
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}

function lcxxcxHTML(datas) {
  var str = "";
  str += "<div><table>";
  str += (
    "<tr>\n"
    + "<td class=\"abs\" title=\"" + h[2] + "\" width='48px'>" + h[3] + "</td>\n"
    + "<td title=\"" + h[2] + "\" width='48px'>" + h[3] + "</td>\n"
    + "<td title=\"22 " + h[22] + "\">" + " " + "</td>\n"
    + "<td title=\"21|32|20|25 " + h[21] + "/" + h[32] + "/" + h[20] + "/" + h[25] + "\">" + "6" + "</td>\n"
    + "<td title=\"23|27 " + h[23] + "/" + h[27] + "\">" + "RW" + "</td>\n"
    + "<td title=\"28|33 " + h[28] + "/" + h[33] + "\">" + "YW" + "</td>\n"
    + "<td title=\"24|31 " + h[24] + "/" + h[31] + "\">" + "RZ" + "</td>\n"
    + "<td title=\"29|30 " + h[29] + "/" + h[30] + "\">" + "YZ" + "</td>\n"
    + "<td title=\"26\">" + h[26] + "</td>\n"
    + "<td title=\"" + h[16] + "\">" + h[8] + "</td>\n"
    + "<td title=\"" + h[17] + "\">" + h[9] + "</td>\n"
    + "<td>" + "站" + "</td>\n"
    + "<td>" + h[10] + "</td>\n"
    + "<td>" + "票价" + "</td>\n"
    + "<td title=\"" + h[6] + "\">" + h[6] + "</td>\n"
    + "<td title=\"" + h[7] + "\">" + h[7] + "</td>\n"
    + "<td title=\"" + h[4] + "\">" + h[4] + "</td>\n"
    + "<td title=\"" + h[5] + "\">" + h[5] + "</td>\n"
    + "<td title=\"yp_ex\">" + h[34] + "</td>\n"
    + "<td title=\"seat_types\">" + h[35] + "</td>\n"
    + "<td>" + h[13] + "</td>\n"
    + "<td title=\"train_seat_feature\">" + h[14] + "</td>\n"
    + "<td title=\"location_code\">" + h[15] + "</td>\n"
    + "<td>" + h[18] + "</td>\n"
    + "<td title=\"" + h[12] + "\">" + h[1] + "|" + h[11] + "</td>\n"
    + "</tr>\n"
  );
  var min = 99;
  for (i = 0; i < datas.length; i++) {
    col = datas[i];
    var a = (col[hkey[17]] - col[hkey[16]]);
    if (a < min && (col[hkey[3]][0] == 'G')) {
      min = a;
    }
  }
  for (i = 0; i < datas.length; i++) {
    col = datas[i];
    sleeper = is_sleeper(col[hkey[8]], col[hkey[9]], col[hkey[10]]);
    str += (
      "<tr class=\"hide" + col[hkey[3]][0] + (col[hkey[19]] > 0 ? " ctl" : "") + (((col[hkey[3]][0] == 'G') && ((col[hkey[17]] - col[hkey[16]]) > min + 1)) ? " hideG-" : "") + "\">\n"
      + "<td class=\"abs type" + traintype(col[hkey[3]], col[hkey[14]]) + (col[hkey[19]] > 0 ? " ctl" : "") + "\" title=\"" + col[hkey[2]] + "\">" + col[hkey[3]] + (col[hkey[36]] > 0 ? "<div class=\"ticket_ex\"></div>" : "") + "</td>\n"
      + "<td class=\"type" + traintype(col[hkey[3]], col[hkey[14]]) + (col[hkey[19]] > 0 ? " ctl" : "") + "\" title=\"" + col[hkey[2]] + "\">" + col[hkey[3]] + "</td>\n"
      + "<td class=\"right " + hbc2(col, 'QH5LCKB0') + "\">" + (hb2(col, 'QH5LCKB0') || "-") + "</td>\n"
      + "<td class=\"right " + hbc2(col, '6A9PQE') + "\">" + (hb2(col, '6A9PQE') || "-") + "</td>\n"
      + "<td class=\"right " + hbc2(col, '4I') + "\">" + (hb2(col, '4I') || "-") + "</td>\n" // ?S
      + "<td class=\"right " + hbc2(col, '3FJ') + (sleeper ? " seat_match" : "") + "\">" + (hb2(col, '3FJ') || "-") + "</td>\n"
      + "<td class=\"right " + hbc2(col, '2M7') + "\">" + (hb2(col, '2M7') || "-") + "</td>\n"
      + "<td class=\"right " + hbc2(col, '1OS8') + (!sleeper ? " seat_match" : " seat_warn") + "\">" + (hb2(col, '1OS8') || "-") + "</td>\n"
      + "<td class=\"right\" style=\"font-weight: lighter;\">" + (col[hkey[26]] || "-") + "</td>\n"
      + "<td title=\"" + col[hkey[16]] + "\">" + col[hkey[8]] + "</td>\n"
      + "<td title=\"" + col[hkey[17]] + "\">" + col[hkey[9]] + "</td>\n"
      + "<td class=\"right\" onclick=\"getSch(schURL('" + col[hkey[2]] + "','" + col[hkey[4]] + "','" + col[hkey[5]] + "','" + col[hkey[13]] + "'))\">" + (col[hkey[17]] - col[hkey[16]]) + "</td>\n"
      + "<td>" + col[hkey[10]] + "</td>\n"
      + "<td title=\"" + col['yp_info'] + "\" class=\"right " + ticketdiscountex(col['yp_ex'], (sleeper ? "3456FAJI12OMPS87E" : "12OMPS87E3456FAJI")) + "\">" + ticketprice(col['yp_info'], (sleeper ? "3456FAJI12OMPS87E" : "12OMPS87E3456FAJI")) + "</td>\n"
      + "<td title=\"" + col[hkey[6]] + "\">" + telename(col[hkey[6]]) + "</td>\n"
      + "<td title=\"" + col[hkey[7]] + "\">" + telename(col[hkey[7]]) + "</td>\n"
      + "<td title=\"" + col[hkey[4]] + "\">" + telename(col[hkey[4]]) + "</td>\n"
      + "<td title=\"" + col[hkey[5]] + "\">" + telename(col[hkey[5]]) + "</td>\n"
      + "<td>" + col[hkey[34]] + "</td>\n"
      + "<td>" + col[hkey[35]] + "</td>\n"
      + "<td>" + col[hkey[13]] + "</td>\n"
      + "<td>" + (col[hkey[14]] || "") + "</td>\n"
      + "<td>" + col[hkey[15]] + "</td>\n"
      + "<td>" + col[hkey[18]] + "</td>\n"
      + "<td title=\"yp_info " + col['yp_info'] + "\">" + (col['note'] || col['controlled_train_message'] || '预订').replace(/<[^>]+>/g, " ") + "|" + col[hkey[11]] + "</td>\n"
      + "</tr>\n"
    );

    console.log(
      col[hkey[2]] + "|" +
      (col[hkey[18]] > 0 ? col[hkey[18]] : " ") + "|" +
      col[hkey[4]] + "|" +
      col[hkey[5]] + "|" +
      col[hkey[16]] + "|" +
      col[hkey[6]] + "|" +
      col[hkey[17]] + "|" +
      col[hkey[7]] + "|" +
      col[hkey[8]] + "|" +
      col[hkey[9]] + "|" +
      col[hkey[10]] + "|" +
      col[hkey[11]] + "|" +
      col[hkey[13]] + "|" +
      col[hkey[14]] + "|" +
      col[hkey[15]] + "|" +
      col[hkey[19]] + "|" +
      col[hkey[20]] + "\t|" +
      col[hkey[21]] + "\t|" +
      col[hkey[22]] + "\t|" +
      col[hkey[23]] + "\t|" +
      col[hkey[24]] + "\t|" +
      col[hkey[25]] + "\t|" +
      col[hkey[26]] + "\t|" +
      col[hkey[27]] + "\t|" +
      col[hkey[28]] + "\t|" +
      col[hkey[29]] + "\t|" +
      col[hkey[30]] + "\t|" +
      col[hkey[31]] + "\t|" +
      col[hkey[32]] + "\t|" +
      col[hkey[33]] + "\t|" +
      col[hkey[3]] + "\t|" +
      col[hkey[34]] + "\t|" +
      col[hkey[35]] + "\t|" +
      col[hkey[36]] + "\t|" +
      col[hkey[37]] + "\t|" +
      col[hkey[38]] + "\t|" +
      col[hkey[12]]// + "\t|" + 
      //col[hkey[36]]
    );
  }
  str += "</table></div>";
  return str;
}


function search(str) {
  var re = /^[GDCZTKYL]{1}[1-9][0-9]{0,3}$|^[1-9][0-9]{0,3}$/
  if (re.test(str.toUpperCase())) {
    search_v1(str.toUpperCase())
    return false
  }
  var re2 = /^[a-zA-Z]{3}$/
  if (re2.test(str)) {
    czxx(str.toUpperCase())
    return false
  }
  if (telecode(str)) {
    czxx(telecode(str))
    return false
  }
  search_v1(str.toUpperCase())
}

function search_v1(str) {
  var date = document.getElementById("date").value;
  var yyyymmdd = date.replace(/-/g, "")
  var url = "https://search.12306.cn/search/v1/train/search?keyword=" + str + "&date=" + yyyymmdd
  document.getElementById("result").innerHTML = str
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        result = ""
        var j = JSON.parse(xhr.responseText);
        if (j.status) {
          result += ("<div>" + (j.data ? j.data.length : 0) + "条</div>")
          for (var i in j.data) {
            var t = j.data[i];
            result += ("<div id=\"" + t.station_train_code + "\">"
              + t.train_no + " " + telecode(t.from_station) + " " + telecode(t.to_station)
              + " " + "<span class=\"type" + traintype(t.station_train_code) + "\" onclick=\"getSch(schURL('" + t.train_no + "','" + telecode(t.from_station) + "','" + telecode(t.to_station) + "','" + date + "'))\">"
              + t.station_train_code + "</span>" + " " + t.from_station + " " + t.to_station
              + " " + "<a href=" + schURL(t.train_no, telecode(t.from_station), telecode(t.to_station), date) + " target='_blank'>" + t.station_train_code + "</a>" + "</div>"
            );
            if (t.station_train_code == str.toUpperCase()) {
              document.getElementById("sch").innerHTML = t.station_train_code + "<br />\n";
              getSch(schURL(t.train_no, telecode(t.from_station), telecode(t.to_station), date));
            }
          }
        } else {
          result += j.errorMsg
        }
        document.getElementById("result").innerHTML = result;
      } else {
        document.getElementById("result").innerHTML = str + " " + xhr.status + " " + (xhr.statusText || "error");
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  //xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}

function czxx(t1) {
  var date = document.getElementById("date").value;
  // var url = "https://kyfw.12306.cn/otn/czxx/query?train_start_date=" + date + "&train_station_code=" + t1
  // var url = "https://www.12306.cn/kfzmpt/czxx/query?train_start_date=" + date + "&train_station_code=" + t1
  var url = "https://kyfw.12306.cn/kfzmpt/czxx/query?train_start_date=" + date + "&train_station_code=" + t1
  document.getElementById("result").innerHTML = t1 + " ";
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        result = ""
        var j = JSON.parse(xhr.responseText);
        if (j.status && j.data) {
          result += ("<div>" + (j.data.data ? j.data.data.length : 0) + "趟 " + j.data.sameStations.join(" ") + "</div>")
          for (i in j.data.data) {
            var t = j.data.data[i];
            result += ("<div id=\"" + t.station_train_code + "\">"
              + t.train_no + " " + telecode(t.start_station_name) + " " + telecode(t.end_station_name)
              + " " + "<span class=\"type" + traintype(t.station_train_code, t.service_type) + "\" onclick=\"getSch(schURL('" + t.train_no + "','" + telecode(t.start_station_name) + "','" + telecode(t.end_station_name) + "','" + date + "'))\">"
              + t.station_train_code + "</span>" + " " + t.start_station_name + " " + t.end_station_name
              + " " + "<a href=" + schURL(t.train_no, telecode(t.start_station_name), telecode(t.end_station_name), date) + " target='_blank'>" + t.station_train_code + "</a>" + "</div>");
          }
        } else {
          result += j.errorMsg
        }
        document.getElementById("result").innerHTML = result;
      } else {
        document.getElementById("result").innerHTML = t1 + " " + xhr.status + " " + (xhr.statusText || "error");
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  //xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}


function zwdcxURL(str, trainNo, cxlx) {
  if (!str) return "";
  if (!trainNo) return "";
  // return "http://www.12306.cn/mapping/kfxt/zwdcx/LCZWD/cx.jsp?cz=" + unicode2gbk(str) + "&cc=" + trainNo + "&cxlx=" + cxlx + "&rq=" + timeStr(0, "yyyy-mm-dd") + "&czEn=" + encodeURI(str).replace(/%/g, "-") + "&tp=" + new Date().getTime();
  // return "https://kyfw.12306.cn/otn/zwdch/query?cxlx=" + cxlx + "&cz=" + encodeURI(str) + "&cc=" + trainNo + "&czEn=" + encodeURI(str).replace(/%/g, "-") // + "&randCode=&&if_check_slide_passcode_token="
  return "https://kyfw.12306.cn/kfzmpt/zwdch/query?cxlx=" + cxlx + "&cz=" + encodeURI(str) + "&cc=" + trainNo + "&czEn=" + encodeURI(str).replace(/%/g, "-") // + "&randCode=&&if_check_slide_passcode_token="
}

function getzwdcx_id(id) {
  var sp = id.split("_");
  if (sp.length > 2) {
    getzwdcx(sp[0], sp[1], sp[2]);
  }
}

function getzwdcx(str, trainNo, cxlx) {
  var url = zwdcxURL(str, trainNo, cxlx)
  if (!url) return;
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var s = xhr.responseText;
      console.log(zwdcxHTML(s));
      setInnerHTML(str + "_" + trainNo + "_" + cxlx, zwdcxHTML(s));
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}

function zwdcxHTML(s) {
  var match = s.match(/\d+:\d+/);
  var time = match ? match[0] : "";
  var match = s.match(/预计|暂无|无时刻|时刻表中无/);
  var status = match ? match[0] : "";
  return status + time;
}


function schURL(train_no, from_tele, to_tele, date) {
  if (!train_no) return "";
  if (!from_tele) return "";
  if (!to_tele) return "";
  d = date.replace(/(\d{4})[-\/]*(\d{2})[-\/]*(\d{2})/, "$1-$2-$3")
  return url = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + train_no + "&from_station_telecode=" + from_tele + "&to_station_telecode=" + to_tele + "&depart_date=" + d;
}

function getSch(url) {
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      if (j.data.data.length >= 0) {
        setInnerHTML("sch", schHTML(j.data.data) + document.getElementById("sch").innerHTML);
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send();
}

function schHTML(sch) {
  if (sch.length == 0) {
    return ""
  }
  var str = "";
  str += ("<div class=\"sch\" id=\"sch_" + sch[0].station_train_code + "\"><div><span class=\"type"
    + traintype(sch[0].station_train_code, sch[0].service_type) + "\">"
    + sch[0].station_train_code + " " + sch[0].train_class_name
    + "</span> " + sch[0].start_station_name + " " + sch[0].end_station_name
    + "</div>\n");
  for (i in sch) {
    str += ("<div id=\"" + sch[i].station_name + "_" + sch[0].station_train_code + "\">"
      + sch[i].station_name + " "
      + sch[i].arrive_time + " "
      + sch[i].start_time + " "
      + sch[i].stopover_time + " "
      + ((i == 0) ? "" : (" <span id=\"" + sch[i].station_name + "_" + sch[0].station_train_code + "_0\" onclick=\"getzwdcx_id(this.id)\">到</span>"))
      + ((i == sch.length - 1) ? "" : (" <span id=\"" + sch[i].station_name + "_" + sch[0].station_train_code + "_1\" onclick=\"getzwdcx_id(this.id)\">发</span>"))
      + "</div>\n");
  }
  str += "</div>"
  return str;
}


function tableHTML(s) {
  var ret = ''
  var rows = s.split("\n")
  ret += "<table>"
  for (var i = 0; i < rows.length; i++) {
    var cols = rows[i].split(",");
    ret += "<tr>"
    for (var j = 0; j < cols.length; j++) {
      ret += "<td>" + cols[j] + "</td>"
    }
    ret += "</tr>"
  }
  ret += "</table>"
  return ret
}

function css_emu(t) {
  if (t.indexOf("BST") > -1) {
    return "typeBSP"
  }

  if (t.indexOf("25T") > -1) {
    return "type25T"
  }

  if (t.indexOf("25DT") > -1) {
    return "type25DT"
  }

  if (t.indexOf("25K") > -1) {
    return "type25K"
  }

  if (t.indexOf("25Z") > -1) {
    return "type25Z"
  }

  if (t.indexOf("25G") > -1) {
    return "type25G"
  }

  if (t.indexOf("25A") > -1) {
    return "type25A"
  }

  if ((t.indexOf("25B") > -1) || (t.indexOf("22") > -1)) {
    return "typeservice_0"
  }

  if (t.indexOf("Z") > -1) {
    if (t.indexOf("AF") > -1) {
      return "type400AFZ"
    }
    if (t.indexOf("BF") > -1) {
      return "type400BFZ"
    }
  }

  if ((t.indexOf("200J-D") > -1) || (t.indexOf("200J1-D") > -1) || (t.indexOf("200J3-C") > -1) || (t.indexOf("200J1-C") > -1) ) {
    return "type200JAD"
  }
  if (t.indexOf("200JS-G") > -1) {
    return "type200JSG"
  }
  if (t.indexOf("200J") > -1) {
    return "type200J"
  }

  if (t.indexOf("300AF") > -1) {
    return "type300AF"
  }
  if (t.indexOf("300BF") > -1) {
    return "type300BF"
  }

  if (t.indexOf("AF") > -1) {
    return "type400AF"
  }
  if (t.indexOf("BF") > -1) {
    return "type400BF"
  }

  return "typeCRH"
}

var bureau_arr = [
  "哈尔滨,哈,B",
  "沈阳,沈,T",
  "北京,京,P",
  "呼和浩特,呼,C",
  "郑州,郑,F",
  "济南,济,K",
  "上海,上,H",
  "南昌,南,G",
  "广州,广,Q",
  "南宁,宁,Z",
  "成都,成,W",
  "昆明,昆,M",
  "兰州,兰,J",
  "乌鲁木齐,乌,R",
  "西宁,青,O",
  "太原,太,V",
  "武汉,武,N",
  "西安,西,Y",
  "香港,港,X"
]

var bureau_map = {}
for (var i = 0; i < bureau_arr.length; i++) {
  var sp = bureau_arr[i].split(",")
  bureau_map[sp[2]] = sp[1]
}

function search_emu(str) {
  var ret = []
  for (var key = 40000; key < 80000; key++) {
    if (!window.emu[key].emu_type) {
      continue
    }
    if (window.emu[key].emu_type.indexOf(str) > -1 || window.emu[key].emu_no == str) {
      ret.push(window.emu[key])
    }
  }

  ret.sort(function (a, b) {
    if (a.emu_type > b.emu_type) return 1
    if (a.emu_type < b.emu_type) return -1
    if (!a.emu_no && b.emu_no) return 1
    if (a.emu_no && !b.emu_no) return -1
    if (a.emu_no > b.emu_no) return 1
    if (a.emu_no < b.emu_no) return -1
    //train start time
    if (window.timetable) {
      var keyA = hash_no(a.train_code) - 1
      var keyB = hash_no(b.train_code) - 1
      if (window.timetable[keyA] && window.timetable[keyB]) {
        if (window.timetable[keyA][0].dep_time > window.timetable[keyB][0].dep_time) return 1
        if (window.timetable[keyA][0].dep_time < window.timetable[keyB][0].dep_time) return -1
      }
    }
    return 0
  })

  var result = ""
  for (var i = 0; i < ret.length; i++) {
    var trainset = ret[i]
    var schstr = ""
    if (window.timetable) {
      var key = hash_no(trainset.train_code) - 1
      var sch = window.timetable[key]
      if (sch) {
        schstr = " " + sch[0].dep_time + " " + sch[sch.length-1].arr_time + " " + telename(sch[0].station) + " " + telename(sch[sch.length-1].station)
      }
    }
    result += "<span onclick=\"get_search_train_csv('" + trainset.train_code + "')\">" + trainset.train_code + "</span> " 
    + emu_type_no(trainset.bureau, trainset.emu_type, trainset.emu_no, trainset.emu_double) + schstr + "<br />\n"

  }
  document.getElementById("emu").innerHTML = result;
}

function emu_by_code(code) {
  var key = hash_no(code.split("/")[0]) - 1
  var trainset = window.emu[key]
  if (!trainset || typeof (trainset.emu_type) != "string") return ""
  return emu_type_no(trainset.bureau, trainset.emu_type, trainset.emu_no, trainset.emu_double)
}

function emu_type_no(bureau, emu_type, emu_no, emu_double) {
  var c = ""
  if (emu_double) {
    c += "double"
  }
  if (emu_type.indexOf("~") > -1) {
    c += " " + "AC380V"
  }
  if (/-$/g.test(emu_type)) {
    c += " " + "DC600V"
  }
  emu_type = emu_type.replace(/[-~]$/g, '')
  c += " " + css_emu(emu_type)
  if (emu_type == 'BF-C' && emu_no == '5162') {
    c += " " + "type400BFC5162"
  }
  if (emu_type == 'BF-Z' && emu_no == '0524') {
    c += " " + "type400BFZ0524"
  }
  return (bureau_map[bureau] || bureau) + " <span class=\"" + c + "\">" + emu_type + " " + emu_no + "</span>"
}

function emu_short_by_code(code) {
  var key = hash_no(code.split("/")[0]) - 1
  var trainset = window.emu[key]
  if (!trainset || typeof (trainset.emu_type) != "string") return ""
  return emu_type_short(trainset.bureau, trainset.emu_type, trainset.emu_no, trainset.emu_double)
}

function emu_type_short(bureau, emu_type, emu_no, emu_double) {
  var c = ""
  if (emu_double) {
    c += "double"
  }
  if (emu_type.indexOf("~") > -1) {
    c += " " + "AC380V"
  }
  if (/-$/g.test(emu_type)) {
    c += " " + "DC600V"
  }
  emu_type = emu_type.replace(/[-~]$/g, '')
  c += " " + css_emu(emu_type)
  if (emu_type == 'BF-C' && emu_no == '5162') {
    c += " " + "type400BFC5162"
  }
  if (emu_type == 'BF-Z' && emu_no == '0524') {
    c += " " + "type400BFZ0524"
  }
  return (bureau_map[bureau] || bureau) + (emu_type?("<span class=\"" + c + "\">" + emu_type.replace("-", "").replace("300", "").replace("200", "")  + "</span>"):"")
}

function getemu() {
  // '/emu/equip'
  // '/emu/ccrgt'
  var url = '/emu/emu' + timeStr(new Date().getTime() - 5 * 3600000, 'yyyymmdd') + '.csv'

  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");

  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        data = xhr.responseText.split("\n");
        window.emu = Array(maxlen)
        for (var i = 0; i < maxlen; i++) {
          window.emu[i] = []
        }

        for (i in data) {
          var row = data[i].split(",");
          var key = hash_no(row[0]) - 1
          var m = (row[2] || "").match(/(.*)-(\d{4})$/)
          window.emu[key] = {
            train_code: row[0] || "",
            bureau: row[1] || "",
            emu_type: (row[2] || "").split("_")[0].replace(/(.*)-(\d{4})$/, "$1").replace(/\(\d+\)$/, "").replace(/^2\*/, "") || "",
            emu_no: m ? m[2] : "",
            emu_double: /2\*|重/.test(row[2]) ? 1 : 0,
            emu_flag: 0,
          }
        }

        setInnerHTML("emu", "")
      } else {
        setInnerHTML("emu", xhr.status + " " + xhr.statusText);
      }
    }
  }

  xhr.open("GET", url, true);
  setInnerHTML("emu", "loading " + url);
  xhr.send()
}

get_search_train_csv(' ')
getemu()


function getbureau(trainNo, id) {
  var date = document.getElementById("date").value;
  var yyyymmdd = date.replace(/-/g, "")
  var url = "https://mobile.12306.cn/wxxcx/wechat/bigScreen/queryTrainBureau"
  var body = "queryDate=" + yyyymmdd + "&trainCode=" + trainNo
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      if (j.data) {
        if(!id) {
          id = "emucar"
          setInnerHTML(id, trainNo + " " + j.data.bureau_code + " " + j.data.bureau_code_name  + " " + j.data.subbureau_code  + " " + j.data.subbureau_code_name  + " " + j.data.startDate + "<br />\n" + document.getElementById(id).innerHTML);
        } else {
          setInnerHTML(id, j.data.bureau_code + " " + j.data.bureau_code_name  + " " + j.data.subbureau_code  + " " + j.data.subbureau_code_name);
        }
      } else {
        if(!id) {
          id = "emucar"
        }
        setInnerHTML(id, trainNo + " " + j.errorMsg + "<br />\n" + document.getElementById("emucar").innerHTML);
      }
    }
  }
  xhr.open("POST", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send(body);
}

function getemuqrcode(emuSeatCode) {
  var url = "https://mobile.12306.cn/wxxcx/wechat/main/travelServiceDecodeQrcode"
  var body = "c=" + emuSeatCode + "-02-01A&w=h"
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      console.log(j.data)
      if (j.data) {
        setInnerHTML("emucar", j.data.carCode + " " + j.data.trainCode + " " + j.data.trainNo + " " + j.data.bureauCode + " " + j.data.bureauName.replace(/中国铁路(.*)集团有限公司/g, "$1") + " " + j.data.deptName + " " + j.data.startDay + " " + j.data.trainRepeat + " " + j.data.coachNo + " " + j.data.seatNo + " " + j.data.seatType + "<br />\n" + document.getElementById("emucar").innerHTML);
      } else {
        setInnerHTML("emucar", emuSeatCode + " " + j.errorMsg + "<br />\n" + document.getElementById("emucar").innerHTML);
      }
    }
  }
  xhr.open("POST", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send(body);
}


function getemucar(code, date) {
  var url = "/mobile.12306.cn/wxxcx/openplatform-inner/miniprogram/wifiapps/appFrontEnd/v2/lounge/open-smooth-common/trainStyleBatch/getCarDetail?carCode=&trainCode=" + code + "&runningDay=" + date + "&reqType=form"
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      console.log(j.data)
      if (j.content && j.content.data) {
        setInnerHTML("emucar", code + " " + j.content.data.carCode + "<br />\n" + document.getElementById("emucar").innerHTML);
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.send()
}

function gettraininfo(code, date) {
  var url = "/mobile.12306.cn/wxxcx/wechat/main/travelServiceQrcodeTrainInfo"
  var body = "trainCode=" + code + "&startDay=" + date + "&startTime=&endDay=&endTime="
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      if (j.data && j.data.trainDetail.stopTime && j.data.trainDetail.stopTime.length) {
        setInnerHTML("emucar", gettraininfoHTML(j) +
        "<br />\n" + document.getElementById("emucar").innerHTML);
      }
    }
  }
  xhr.open("POST", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send(body);
}

function gettraininfoHTML(j) {
  var ret = (j.data.trainDetail.trainCode.stationTrainCodeAll || j.data.trainDetail.trainCode) + " " + 
  j.data.trainDetail.stopTime[0].jiaolu_train_style + " " +
  j.data.trainDetail.stopTime[0].jiaolu_dept_train + " " +
  j.data.trainDetail.stopTime[0].jiaolu_corporation_code + " " +
  (j.data.trainDetail.stopTime[0].train_style || "-") + " " +
  j.data.trainDetail.stopTime[0].train_flag + " " +
  (j.data.trainDetail.trainsetTypeInfo? ("<br />\n" + (j.data.trainDetail.trainsetTypeInfo.trainsetTypeName || "-") + " " + (j.data.trainDetail.trainsetTypeInfo.indexKey || "-")) :"") + 
  "<br />\n"

  for (var i=0; i<j.data.trainDetail.stopTime.length; i++) {
    ret += j.data.trainDetail.stopTime[i].arriveTime + " " +
    j.data.trainDetail.stopTime[i].startTime + " " +
    j.data.trainDetail.stopTime[i].ticketDelay + " " +
    (j.data.trainDetail.stopTime[i].channel || "-") + " " +
    (j.data.trainDetail.stopTime[i].ticketStatus || "-") + " " +
    j.data.trainDetail.stopTime[i].stationName + "\t" +
    j.data.trainDetail.stopTime[i].wicket + "|" +
    j.data.trainDetail.stopTime[i].waitingRoom + "|" +
    j.data.trainDetail.stopTime[i].exit +
    "<br />\n"
  }
  return ret
}


function gettrainmapline(trainNo) {
  var url = "https://mobile.12306.cn/wxxcx/wechat/main/getTrainMapLine"
  var body = "version=v2&trainNo=" + trainNo
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      var ret = "";
      for (var i in j.data) {
        ret += j.data[i].index + " " + i + "<br />\n"
      }
      setInnerHTML("emucar", trainNo + "<br />\n" + ret + 
        "<br />\n" + document.getElementById("emucar").innerHTML);
    }
  }
  xhr.open("POST", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send(body);
}


function crqrcheck() {
  var url = "/cr/check"
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        var j = JSON.parse(xhr.responseText);
        if (j.code == 0) {
          setInnerHTML("login",'已登录' + timeStr(0, 'HH:MM:SS'))
          setInnerHTML("login_status",' ')
        }
        if (j.code == -1) {
          setInnerHTML("login",'需要登录')
          getcrqr()
        }
      } else {
        setInnerHTML("login_status", xhr.status + " " + xhr.statusText);
        setInnerHTML("emucar", xhr.responseText);
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  setInnerHTML("login_status", "load");
  xhr.send()
}

function getcrqr() {
  var url = "/cr/qr/json"
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        var j = JSON.parse(xhr.responseText);
        setInnerHTML("login",'二维码')
        setInnerHTML("login_status",'<a href="com.12306://12306/QRLogin?loginUUID='+ j.uuid+'">12306</a>')
        getcheckqr(j.uuid)
      } else {
        setInnerHTML("login_status", xhr.status + " " + xhr.statusText);
        setInnerHTML("emucar", xhr.responseText);
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.send()
}

function getcheckqr(uuid) {
  var url = "/cr/qr/check/" + uuid
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
      var j = JSON.parse(xhr.responseText);
      if (j.code == 0) {
        setInnerHTML("login",'本次登录' + timeStr(0, 'HH:MM:SS'))
        setInnerHTML("login_status",' ')
      } else {
        setInnerHTML("login_status", xhr.status + " " + xhr.statusText);
        setInnerHTML("emucar", xhr.responseText);
      }
    }
  }
  xhr.open("GET", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.send()
}

function getcrleftraw(rowstr, date, trid) {
  var url = "/cr/leftraw/" + date
  var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if ([200, 304].indexOf(xhr.status) > -1) {
        setrawleft(xhr.responseText, trid)
      } else {
        setInnerHTML("login_status", xhr.status + " " + xhr.statusText);
      }
    }
  }
  xhr.open("POST", url.replace(/^http[s]*:\/\//g, endpoint), true);
  xhr.send(rowstr)
}

function setrawleft(str, trid) {
  var etr = document.getElementById(trid)
  if (!etr) return
  var etds = etr.getElementsByTagName('td')
  if (!etds || etds.length < 8) return

  etds[2].innerHTML = ticketrawleft(str, 'QH5LCKB0W') || etds[2].innerHTML
  etds[3].innerHTML = ticketrawleft(str, '6A9PQE') || etds[3].innerHTML
  etds[4].innerHTML = ticketrawleft(str, '4I') || etds[4].innerHTML
  etds[5].innerHTML = ticketrawleft(str, '3FJ') || etds[5].innerHTML
  etds[6].innerHTML = ticketrawleft(str, '2M7') || etds[6].innerHTML
  etds[7].innerHTML = ticketrawleft(str, '1OS8') || etds[7].innerHTML
}

function ticketrawleft(str, cc) {
  if (typeof (str) != "string") {
    return ""
  }
  for (var ii in cc) {
    var c = cc[ii];
    if (c == 'W') {
      for (var i = 0; i + 9 < str.length; i += 10) {
        var num = Number(str.slice(i + 6, i + 10))
        if (num > 3000) {
          return num - 3000
        }
      }
    }
    for (var i = 0; i + 9 < str.length; i += 10) {
      if (c == str[i]) {
        return pricefont(str.slice(i + 6, i + 10).replace(/^[0]{1,3}/, ""))
      }
    }
  }
  return ""
}


</script>
</body>

</html>