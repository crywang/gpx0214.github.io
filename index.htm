<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, monospace;
    }

    input {
      font-size: 1em;
      width: 30%;
      max-width: 20em;
    }

    .sch {
      margin: 0.5em;
      display: inline-table;
    }

    table {
      border-collapse: collapse;
    }

    td {
      white-space: nowrap;
      word-wrap: keep-all;
      word-break: keep-all;
    }

    .abs {
      position: absolute;
    }

    .rel {
      position: relative;
    }

    .hide {
      display: none;
    }

    .typeZ {
      background-color: #004a80;
      color: #ffffff;
    }

    .typeT {
      background-color: #1445b8;
      color: #c32230;
    }

    .typeK,
    .typeY,
    .type1,
    .type2,
    .type3,
    .type4,
    .type5,
    .type6,
    .type7,
    .type8,
    .type9 {
      background-color: #cc4c33;
      color: #ffffff;
    }

    .type200J {
      background-color: #29a352;
      color: #e6cc4c
    }

    .typeservice_0 {
      background-color: #567e60;
      color: #fff700
    }

    .typeG {
      background-color: #d4d4d4;
      color: #a80022
    }

    .typeC {
      background-color: #bf9540;
      color: #ffffff;
    }

    .typeD,
    .typeS {
      background-color: #ffffff;
      color: #3d668f;
    }

    .ctl {
      color: #999999;
      text-decoration-line: line-through;
      text-decoration-color: #FF0000;
    }

    #ticket {
      white-space: nowrap;
      word-wrap: keep-all;
      word-break: keep-all;
    }

    .ticket_full {
      background-color: #569b4c;
      color: #ffffff;
    }

    .ticket_warn,
    .seat_warn.ticket_full {
      background-color: #ef8a3b;
      color: #ffffff;
    }

    .ticket_hb {
      background-color: #ffffff;
      color: #5697f5;
    }

    .ticket_out {
      background-color: #ffffff;
      color: #999999;
    }

    .ticket_discount {
      background-color: #ffffff;
      color: #cc4c33;
    }

    .seat_match {
      font-weight: bolder;
      text-decoration: underline #cccccc;
    }

    .weekend {
      color: #ff0000;
      text-decoration: underline #ff0000;
    }
  </style>
  <style title='hide'>
  </style>
</head>

<body>
  <div id="time"></div>
  <form>
    <span onclick="setValue('date',dateAdd(getValue('date'),-7))">-7</span>
    <span onclick="setValue('date',dateAdd(getValue('date'),-1))">-1</span>
    <input type="date" id="date" onchange="console.log(this.value)" />
    <span onclick="setValue('date',dateAdd(getValue('date'),1))">+1</span>
    <span onclick="setValue('date',dateAdd(getValue('date'),7))">+7</span>
    <span onclick="setValue('date',dateAdd(timeStr(0, 'yyyy-mm-dd'),29))">+29</span>
    <br />
    <input type="text" id="keyword" placeholder="车次或站名" style="max-width:10em" onchange="console.log(this.value)" />
    <!--input name="btn" type="submit" value="车次查询" onclick="search_train_list(getValue('keyword'));return false;"//-->
    <input name="btn" type="submit" value="本地查询" style="max-width:6em"
      onclick="get_search_train_csv(getValue('keyword'));return false;">
    <input name="btn" type="submit" value="查询" style="max-width:5em"
      onclick="search(getValue('keyword'));return false;">
    <!--input name="btn" type="submit" value="车次查询" onclick="search_v1(getValue('keyword'));return false;">
    <input name="btn" type="submit" value="车站车次" onclick="czxx(getValue('keyword'));return false;"//-->
    <br />
  </form>
  <div id="sch"></div>
  <div id="result" style="white-space: nowrap;"></div>
  <form>
    <span style="position: relative;">
      <input type="text" id="form_station" placeholder="出发站"
        onkeyup="setHTML('from_tele', telecode(this.value));qss(this.value)" />
      <span id="from_tele" style="position:absolute;right:0.5em;bottom:0em;"></span>
    </span>
    <span onclick="changeFromTo()">&lt;&gt;</span>
    <span style="position: relative;">
      <input type="text" id="to_station" placeholder="终到站" onkeyup="setHTML('to_tele',telecode(this.value))" />
      <span id="to_tele" style="position:absolute;right:0.5em;bottom:0em;"></span>
    </span>
    <input name="btn" type="submit" value="余票查询"
      onclick="getTicket(getValue('form_station'),getValue('to_station'), getValue('date'));return false;">
    <br />
  </form>
  <div id="qss" style="white-space: nowrap;">
  </div>
  <div id="ticket_date">
  </div>
  <div>
    <span onclick="for (i=0;i<document.styleSheets.length;i++) {
      var ss = document.styleSheets[i]
      if (ss.title == 'hide') {
        var j = ss.cssRules.length
        while (j) {
          ss.removeRule(--j)
        }
        ss.insertRule('.hideG-,.hideD,.hideC,.hideK{display:none}')
      }
    };return false;">GZT</span>
    <span onclick="for (i=0;i<document.styleSheets.length;i++) {
      var ss = document.styleSheets[i]
      if (ss.title == 'hide') {
        var j = ss.cssRules.length
        while (j) {
          ss.removeRule(--j)
        }
        ss.insertRule('.hideG,.hideC,.hideK{display:none}')
      }
    };return false;">DZT</span>
    <span onclick="for (i=0;i<document.styleSheets.length;i++) {
      var ss = document.styleSheets[i]
      if (ss.title == 'hide') {
        var j = ss.cssRules.length
        while (j) {
          ss.removeRule(--j)
        }
        ss.insertRule('.hideC,.hideK{display:none}')
      }
    };return false;">GDZT</span>
    <span onclick="for (i=0;i<document.styleSheets.length;i++) {
      var ss = document.styleSheets[i]
      if (ss.title == 'hide') {
        var j = ss.cssRules.length
        while (j) {
          ss.removeRule(--j)
        }
        ss.insertRule('.hideG,.hideD,.hideC{display:none}')
      }
    };return false;">ZTK</span>
    <span onclick="for (i=0;i<document.styleSheets.length;i++) {
      var ss = document.styleSheets[i]
      if (ss.title == 'hide') {
        var j = ss.cssRules.length
        while (j) {
          ss.removeRule(--j)
        }
        ss.insertRule('.hideG,.hideD,.hideC,.hideK{display:none}')
      }
    };return false;">ZT</span>
    <span onclick="for (i=0;i<document.styleSheets.length;i++) {
      var ss = document.styleSheets[i]
      if (ss.title == 'hide') {
        var j = ss.cssRules.length
        while (j) {
          ss.removeRule(--j)
        }
      }
    };return false;">All</span>
    <span onclick="setHTML('ticket', '');return false;">清除余票</span>
  </div>
  <div id="ticket"></div>
  <a href="https://kyfw.12306.cn/otn/resources/js/query/train_list.js?scriptVersion=1.0">train_list.js</a>
  <br />
  <a href="https://kyfw.12306.cn/otn/resources/js/framework/station_name.js">station_name.js</a>
  <br />
  <a href="http://www.gtbyxx.com/wxg/ky/zhengwan.jsp" target="_blank">广铁正晚点</a>
  <br />
  <a href="http://61.161.203.55/mobile.myweixin.com/FtStationSch.html" target="_blank">沈局时刻表</a>
  <br />
  <a href="https://www.12306.cn/kfzmpt/lcxxcx/init" target="_blank">旧版余票</a>
  <br />
  <a href="https://www.12306.cn/kfzmpt/leftTicketPrice/init" target="_blank">旧版票价</a>
  <br />
  <script src="js/UNICODE2GBK.js" type="text/javascript"></script>
  <script src="js/station_name.js" type="text/javascript"></script>
  <script src="js/qss.js" type="text/javascript"></script>
  <!--script src="https://kyfw.12306.cn/otn/resources/js/framework/station_name.js" type="text/javascript"></script//-->
  <!--script src="js/train_list.js" type="text/javascript"></script//-->
  <!--script src="https://kyfw.12306.cn/otn/resources/js/query/train_list.js?scriptVersion=1.0" type="text/javascript"></script//-->
  <script>
    function setHTML(id, str) {
      e = document.getElementById(id);
      e && (e.innerHTML = str);
    }

    function setValue(id, str) {
      e = document.getElementById(id);
      e && (e.value = str);
    }

    function getValue(id) {
      e = document.getElementById(id);
      return e ? e.value : "";
    }

    function changeFromTo() {
      var from = getValue("form_station");
      var to = getValue("to_station");
      setValue("form_station", to);
      setValue("to_station", from);
      setHTML('from_tele', telecode(to))
      setHTML('to_tele', telecode(from))
      qss(to)
    }

    window.LeftTicketUrl = "leftTicket/query"; // 余票默认URL

    function startTime() {
      clearTimeout(this.timeoutId);              //清除上一个定时器
      var that = this;                      //将this关键字移动至本次refresh()执行中

      var d = new Date()
      var yyyy = ('0000' + d.getFullYear()).slice(-4)
      var month = ('00' + (d.getMonth() + 1)).slice(-2);//Date().getMonth() 0,1,2,...,11
      var dd = ('00' + d.getDate()).slice(-2)
      var hh = ('00' + d.getHours()).slice(-2);
      var mm = ('00' + d.getMinutes()).slice(-2);
      var ss = ('00' + d.getSeconds()).slice(-2);
      var xxx = ('000' + d.getMilliseconds()).slice(-3);
      var day = new Date().getDay();//0,1,2,...,6
      var str_day = new Array("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat");
      var day_month = new Array(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);

      day_month[2 - 1] = 28;
      if (isLeap(y))
        day_month[2 - 1] = 29;

      curr_dd = dd - day;
      curr_month = month;
      if (curr_dd < 1) {//fix last Sun
        curr_month--;
        while (curr_month < 1) curr_month += 12;
        curr_dd += day_month[(curr_month - 1)];
      }

      str_week = ""
      for (i = 0; i < 7; i++) {
        str_week += " " + curr_dd;
        curr_dd++;
        while (curr_dd > day_month[(curr_month - 1) % 12]) {
          curr_dd -= day_month[(curr_month - 1) % 12];
          curr_month++;
          curr_month %= 12;
        }
      }

      document.getElementById('time').innerHTML = (yyyy + "-" + month + "-" + dd + " " + hh + ":" + mm + ":" + ss + " " + str_day[day]).fontcolor("#cc0044") + " " + str_week + "<br />";
      this.timeoutId = window.setTimeout(startTime, 100);   //刷新时间
    }
    //window.onload = startTime

    function isLeap(y) {
      if (y & 0x03)
        return 0;
      if (y % 400 == 0)
        return 1;
      if (y % 100 == 0)
        return 0;
      return 1;
    }

    function dateAdd(date, diff) {
      if (typeof (date) != 'string') return ''
      var f = 'yyyy-mm-dd'
      var day_month = new Array(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);

      match = date.match(/(\d+)-(\d+)-(\d+)/)
      if (!match) return ''
      y = Number(match[1])
      m = Number(match[2])
      d = Number(match[3])

      day_month[2 - 1] = 28;
      if (isLeap(y))
        day_month[2 - 1] = 29;

      d += diff
      // console.log(y, m, d)

      while (d > day_month[(m - 1) % 12]) {
        // console.log(m, day_month[(m - 1) % 12])
        d -= day_month[(m - 1) % 12];
        m++;
        // console.log(y, m, d)
        while (m > 12) {
          m -= 12;
          y += 1;
          day_month[2 - 1] = 28;
          if (isLeap(y))
            day_month[2 - 1] = 29;
          // console.log(y, m, d)
        }
      }

      while (d < 1) {
        m--;
        while (m < 1) {
          y -= 1;
          day_month[2 - 1] = 28;
          if (isLeap(y))
            day_month[2 - 1] = 29;
          m += 12;
          // console.log(y, m, d)
        }
        // console.log(m, day_month[(m - 1) % 12])
        d += day_month[(m - 1) % 12];
        // console.log(y, m, d)
      }

      return f
        .replace("yyyy", ('0000' + y).slice(-4))
        .replace("mm", ('00' + m).slice(-2))
        .replace("dd", ('00' + d).slice(-2))
    }

    function weekday(date) {
      if (typeof (date) != 'string') return -1
      match = date.match(/(\d+)-(\d+)-(\d+)/)
      if (!match) return -1
      y = Number(match[1])
      m = Number(match[2])
      d = Number(match[3])

      if (m <= 2) {
        m += 12;
        y -= 1;
      }

      c = y / 100 | 0;
      y = y % 100;

      var w = y + (y / 4 | 0) + (c / 4 | 0) - 2 * c + ((13 * (m + 1)) / 5 | 0) + d - 1;
      while (w < 0) {
        w += 7;
      }
      while (w >= 7) {
        w -= 7;
      }
      return w | 0
    }

    function timeStr(i, ff) {
      var n = Number(i);
      var f = ff ? ff : "yyyy-mm-dd HH:MM:SS.xxx"
      n > 0x7FFFFFFF ? n *= 1 : n *= 1000;
      var d = n > 0 ? new Date(n) : new Date();
      return f
        .replace("yyyy", ('0000' + d.getFullYear()).slice(-4))
        .replace("mm", ('00' + (d.getMonth() + 1)).slice(-2))
        .replace("dd", ('00' + d.getDate()).slice(-2))
        .replace("HH", ('00' + d.getHours()).slice(-2))
        .replace("MM", ('00' + d.getMinutes()).slice(-2))
        .replace("SS", ('00' + d.getSeconds()).slice(-2))
        .replace("xxx", ('000' + d.getMilliseconds()).slice(-3));
    }

    function ticket_date() {
      holiday = ['2020-01-01',
        '2020-01-24', '2020-01-25', '2020-01-26', '2020-01-27', '2020-01-28', '2020-01-29', '2020-01-30',
        '2020-04-04', '2020-04-05', '2020-04-06',
        '2020-05-01', '2020-05-02', '2020-05-03', '2020-05-04', '2020-05-05',
        '2020-06-25', '2020-06-26', '2020-06-27',
        '2020-10-01', '2020-10-02', '2020-10-03', '2020-10-04', '2020-10-05', '2020-10-06', '2020-10-07', '2020-10-08']
      var h = 0
      var html = ''
      base_date = timeStr(0, "yyyy-mm-dd")
      for (var i = 0; i < 30; i++) {
        cur_date = dateAdd(base_date, i)
        day = weekday(cur_date)
        if (1 << day & 0x41 || holiday.indexOf(cur_date) >= 0) { // 0b1000001
          // console.log(cur_date, day)
          h |= 1 << i
        }
      }

      for (var i = 0; i < 30; i++) {
        valid = h | h << 1 | h >> 1 | h >> 2 | 1 << 0 | 1 << 1 | 1 << 29
        cur_date = dateAdd(base_date, i)
        if (1 << i & valid) {
          html += "<span" + (1 << i & h ? " class=\"weekend\"" : "") + " onclick=\"getlcxxcx(getValue('form_station'),getValue('to_station'), '" + cur_date + "');return false;\">" + cur_date.replace(/(\d{4})[-\/]*(\d{2})[-\/]*(\d{2})/, "$3") + "</span>\n"
        }
      }
      document.getElementById("ticket_date").innerHTML += html;
    }


    date = timeStr(0, "yyyy-mm-dd")
    //document.writeln(date + "<br />")
    setValue("date", date);

    ticket_date()

    var s = [];
    if (typeof (station_names) != "undefined") {
      var s1 = station_names.split("@");
      for (var i = 0; i < s1.length; i++) {
        var ss = s1[i];
        if (ss.length > 0) {
          ss = ss.split("|");
          s.push(ss);
        }
      }
      s.push(["dxc", "大兴机场", "IWP", "daxingjichang", "dxjc", "-1"]);
      s.push(["", "香港红磡", "JQO", "xiangganghongkan", "xghk", "-1"]); //ktt
      s.push(["jlo", "九龙", "JQO", "jiulong", "jl", "-1"]); //ktt
      // s.push(["", "香港西九龙", "XJA", "xianggangxijiulong", "xgxjl", "-1"])
      // s.push(["tsn", "唐山南", "TNP", "tangshannan", "tsn", "-1"]);
      s.push(["gye", "古冶", "GYP", "guye", "gy", "-1"]);
      s.push(['csh', '春申', 'CWH', 'chunshen', 'cs', '-1']);
      s.push(['xqi', '新桥', 'XQH', 'xinqiao', 'xq', '-1']);
      // s.push(['', '车墩', 'CDH', 'chedun', 'cd', '-1']);
      s.push(['yxi', '叶榭', 'YOH', 'yexie', 'yx', '-1']);
      // s.push(['', '亭林', 'TLH', 'tinglin', 'tl', '-1']);
      // s.push(['', '金山园区', 'BGH', 'jinshanwei', 'jsw', '-1']);
      s.push(['jsw', '金山卫', 'BGH', 'jinshanwei', 'jsw', '-1']);
      s.push(['mji', '梅江', 'MKQ', 'meijiang', 'mj', '-1']);
      s.push(['ylo', '元龙', 'YLY', 'yuanlong', 'yl', '-1']);
      s.push(['bdl', '八达岭', 'ILP', 'badaling', 'bdl', '-1']);
      // s.push(['nsb', '南山北', 'NBQ', 'nanshanbei', 'nsb', '-1']);
      // s.push(['', '羊木', 'YMJ', 'yangmu', 'ym', '-1']);
      /* for (var i = 0; i < s.length; i++) {
        s[i].push(i)
      } */
    }

    /*window.namemap = {}
    for (i in s) {
      window.namemap[s[i][2]] = s[i][1]
    }*/

    function telecode(name) {
      for (ii in s) {
        if (s[ii][1] === name) {
          return s[ii][2];
        }
      }
      return "";
    }

    function name(tele) {
      for (ii in s) {
        if (s[ii][2] === tele) {
          return s[ii][1];
        }
      }
      return tele || "";
    }

    function getSchURL(code) { //TODO uppercase
      if (!typeof (code) === "string") {
        return "";
      }

      type = ""
      switch (code[0]) {
        case 'G':
          type = "G";
          break;
        case 'D':
          type = "D";
          break;
        case 'C':
          type = "C";
          break;
        case 'Z':
          type = "Z";
          break;
        case 'T':
          type = "T";
          break;
        case 'K':
          type = "K";
          break;
        default:
          type = "O";
          break;
      }
      var date = getValue("date");
      for (i in train_list[date][type]) {
        t = train_list[date][type][i];
        match = t.station_train_code.match(/(.*)\((.*)-(.*)\)/);
        if (match && match[1] == code) {
          url = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + t.train_no + "&from_station_telecode=" + telecode(match[2]) + "&to_station_telecode=" + telecode(match[3]) + "&depart_date=" + date;
          return url;
        }
      }
      return "";
    }

    function zwdcxURL(str, trainNo, cxlx) {
      if (!str) return "";
      if (!trainNo) return "";
      return "http://www.12306.cn/mapping/kfxt/zwdcx/LCZWD/cx.jsp?cz=" + unicode2gbk(str) + "&cc=" + trainNo + "&cxlx=" + cxlx + "&rq=" + timeStr(0, "yyyy-mm-dd") + "&czEn=" + encodeURI(str).replace(/%/g, "-") + "&tp=" + new Date().getTime();
    }

    /*
    a = getURL(getSchURL("1461")); //时刻
    var j = JSON.parse(a);
    var sch = j.data.data;
    str = "";
    for (i in sch) {
      if(i > 0) {
        str += (sch[0].station_train_code + " " + sch[i].station_name + " " + sch[i].arrive_time + " " + "0" + " <a href=\"" + zwdcx(sch[i].station_name, sch[0].station_train_code, 0) + "\" target=\"_blank\">正晚点</a><br />\n");
      }
      if(i < sch.length - 1) {
        str += (sch[0].station_train_code + " " + sch[i].station_name + " " + sch[i].start_time + " " + "1" + "  <a href=\"" + zwdcx(sch[i].station_name, sch[0].station_train_code, 1) + "\" target=\"_blank\">正晚点</a><br />\n");
      }
    }
    
    console.log(str);
    document.getElementById("sch").innerHTML = str + "<br />\n" + document.getElementById("sch").innerHTML;
    
    
    str = "";
    str += (sch[0].station_train_code + " " + sch[0].train_class_name + " " + sch[0].start_station_name + " " + sch[0].end_station_name + "<br />\n");
    for (i in sch) {
      if(i >= 0) {
        str += (sch[i].station_name + " " + sch[i].arrive_time + " " + sch[i].start_time + " " + sch[i].stopover_time + "<br />\n");
      }
    }
    */

    // setTimeout(function(){getzwdcx(zwdcx("沧州","k522",0))}, 3600000);

    function getzwdcx_id(id) {
      var sp = id.split("_");
      if (sp.length > 2) {
        getzwdcx(sp[0], sp[1], sp[2]);
      }
    }

    function getzwdcx(str, trainNo, cxlx) {
      var url = zwdcxURL(str, trainNo, cxlx)
      if (!url) return;
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
          var s = xhr.responseText;
          console.log(zwdcxHTML(s));
          setHTML(str + "_" + trainNo + "_" + cxlx, zwdcxHTML(s));
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    function zwdcxHTML(s) {
      var match = s.match(/\d+:\d+/);
      var time = match ? match[0] : "";
      var match = s.match(/预计|暂无|无时刻/);
      var status = match ? match[0] : "";
      return status + time;
    }


    function getURL(url) {
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), false);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
      return xhr.responseText;
    }


    function schURL(train_no, from_tele, to_tele, date) {
      if (!train_no) return "";
      if (!from_tele) return "";
      if (!to_tele) return "";
      d = date.replace(/(\d{4})[-\/]*(\d{2})[-\/]*(\d{2})/, "$1-$2-$3")
      return url = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + train_no + "&from_station_telecode=" + from_tele + "&to_station_telecode=" + to_tele + "&depart_date=" + d;
    }

    function traintype(code, service) {
      if (service == '0') {
        return "service_0"
      }
      if ('DC'.indexOf(code[0]) > -1 && /^D[78]\d\d$|^D54\d\d$|^D663[56]$|^C15\d\d$|^C56[5-9]\d$|^C5[78]\d\d$|^C81[0-4]\d$|^C8[34]\d\d$|^C87[2-9]\d$|^C950\d$/.test(code)) {
        return "200J"
      }
      return code[0]
    }

    function getSch(url) {
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 200) {
          var j = JSON.parse(xhr.responseText);
          if (j.data.data.length >= 0) {
            setHTML("sch", schHTML(j.data.data) + document.getElementById("sch").innerHTML);
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    function schHTML(sch) {
      if (sch.length == 0) {
        return ""
      }
      var str = "";
      str += ("<div class=\"sch\" id=\"sch_" + sch[0].station_train_code + "\"><div><span class=\"type"
        + traintype(sch[0].station_train_code, sch[0].service_type) + "\">"
        + sch[0].station_train_code + " " + sch[0].train_class_name
        + "</span> " + sch[0].start_station_name + " " + sch[0].end_station_name
        + "</div>\n");
      for (i in sch) {
        str += ("<div id=\"" + sch[i].station_name + "_" + sch[0].station_train_code + "\">"
          + sch[i].station_name + " "
          + sch[i].arrive_time + " "
          + sch[i].start_time + " "
          + sch[i].stopover_time + " "
          + ((i == 0) ? "" : (" <span id=\"" + sch[i].station_name + "_" + sch[0].station_train_code + "_0\" onclick=\"getzwdcx_id(this.id)\">到</span>"))
          + ((i == sch.length - 1) ? "" : (" <span id=\"" + sch[i].station_name + "_" + sch[0].station_train_code + "_1\" onclick=\"getzwdcx_id(this.id)\">发</span>"))
          + "</div>\n");
      }
      str += "</div>"
      return str;
    }

    function getTicket(from, to, date) {
      var from_station_telecode = telecode(from);
      var to_station_telecode = telecode(to);
      if (!from_station_telecode) {
        return;
      }
      if (!to_station_telecode) {
        return;
      }
      //成人ADULT 学生0X00
      var url = "https://kyfw.12306.cn/otn/" + window.LeftTicketUrl
        + "?leftTicketDTO.train_date=" + date
        + "&leftTicketDTO.from_station=" + from_station_telecode
        + "&leftTicketDTO.to_station=" + to_station_telecode + "&purpose_codes=ADULT";
      if (!document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode)) {
        document.getElementById("ticket").innerHTML =
          "<div id=\"" + date + "_" + from_station_telecode + "_" + to_station_telecode + "\">"
          + date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
          + "</div>\n" + document.getElementById("ticket").innerHTML;
      }
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if ([200, 304].indexOf(xhr.status) > -1) {
            var j = JSON.parse(xhr.responseText);
            if (!j.status) {
              window.LeftTicketUrl = j.c_url || window.LeftTicketUrl;
            }
            document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode).innerHTML =
              date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
              + " center: " + xhr.getResponseHeader("center")
              + " X-Via: " + xhr.getResponseHeader("X-Via") + "<br />\n"
              + ticketHTML(j.data.result, j.data.map);
          } else {
            document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode).innerHTML =
              date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
              + " " + xhr.status + " " + (xhr.statusText || "error");
          }
          if ([302].indexOf(xhr.status) > -1) {
            var j = JSON.parse(xhr.responseText);
            if (!j.status) {
              window.LeftTicketUrl = j.c_url || window.LeftTicketUrl;
              getTicket(from, to, date)
            }
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    var class_map = {
      "6": 21,
      "A": 21,

      "Q": 22, // 400BF-C多功能座 ?20
      "5": 22, // other
      "H": 22, // other
      "B": 22, // other
      "C": 22, // other
      "E": 22, // other
      "K": 22, // other
      "L": 22, // other

      "I": 23, // 
      "4": 23,

      "7": 31, //24
      "2": 24,

      "P": 25,
      "WZ": 26,
      "S": 27, // ?
      "J": 28,
      "3": 28,

      "8": 30, // 29
      "1": 29,

      "O": 30,
      "M": 31,
      "9": 32,
      "F": 33,
    }

    var header = [
      "secretStr", //0
      "按钮",
      "车次号",
      "车次",
      "始发",
      "终到",
      "出发",
      "到达",
      "发时",
      "到时",
      "历时", //10
      "可以购买", // Y/N/IS_TIME_NOT_BUY
      "12",   // yp_info decodeURIComponent base64 crypt
      "始发日",
      "14",   //train_seat_feature
      "15",   //location_code
      "发#",  //16
      "到#",  //17
      "card", //18
      "ctl",  //19
      "gg",   //20 gg_num ?Q观光座
      "GR",   //21 6 高级软卧 //A D954 高级动卧
      "其他", //22 5 K23 K3 包厢硬卧  //H T31 一人软包 //K9686 一人软包 //old A D954 高级动卧
      "RW",   //23 4 软卧 // D7xx 一等卧
      "RZ",   //24 2 软座
      "ZT",   //25 P 特等 CRH3
      "无",   //26 1|2|O 无座
      "yb",   //27 ?S一等包座
      "YW",   //28 3 硬卧 // D7xx 二等卧
      "YZ",   //29 1 硬座
      "ZE",   //30 O 二等座 //O D7xx 二等座
      "ZY",   //31 M 一等座
      "ZS",   //32 9 商务座
      "WY",   //33 F (纵向)动卧 D311
      "打折", //34 打折 10401031
      "席别", //35
      "兑",   //36 exchange_train_flag 兑换
      "候补", //37 houbu_train_flag 候补
      "停止候补" // 38 houbu_seat_limit 不能候补席别
    ]

    var headerkey = [
      "secretStr", //0
      "buttonTextInfo",
      "train_no",
      "station_train_code",
      "start_station_telecode",
      "end_station_telecode",
      "from_station_telecode",
      "to_station_telecode",
      "start_time",
      "arrive_time",
      "lishi", //10
      "canWebBuy", // Y/N/IS_TIME_NOT_BUY
      "yp_info",
      "start_train_date",
      "train_seat_feature",   //train_seat_feature
      "location_code",   //location_code
      "from_station_no",  //16
      "to_station_no",  //17
      "is_support_card", //18
      "controlled_train_flag",  //19
      "gg_num",   //20 gg_num ?Q观光座
      "gr_num",   //21 6 高级软卧 //A D954 高级动卧
      "qt_num", //22 5 K23 K3 包厢硬卧  //H T31 一人软包 //K9686 一人软包 //old A D954 高级动卧
      "rw_num",   //23 4 软卧 // D7xx 一等卧
      "rz_num",   //24 2 软座
      "tz_num",   //25 P 特等 CRH3
      "wz_num",   //26 1|2|O 无座
      "yb_num",   //27 ?S一等包座
      "yw_num",   //28 3 硬卧 // D7xx 二等卧
      "yz_num",   //29 1 硬座
      "ze_num",   //30 O 二等座 //O D7xx 二等座
      "zy_num",   //31 M 一等座
      "swz_num",  //32 9 商务座
      "srrb_num", //33 F (纵向)动卧 D311
      "yp_ex",    //34 打折 10401031
      "seat_types", //35 席别
      "exchange_train_flag",//36 exchange_train_flag 兑换
      "houbu_train_flag",   //37 houbu_train_flag 候补
      "houbu_seat_limit"    //38 houbu_seat_limit 不能候补席别
      //39 yp_info
    ]

    function ticketcolor(col, cc) {
      for (var i in cc) {
        var c = cc[i];
        var n = class_map[c] || 22;
        var s = col[n];
        if (col[35].indexOf(c) == -1) {
          continue;
        }
        if (s == '') {
          continue;
        }
        if (s == '--') {
          continue;
        }
        if (s == '有' || s > 20) {
          return "ticket_full"
        }
        if (s == '无') {
          if (col[37] > 0 && col[38] != "null" && col[38].indexOf(c) == -1) return "ticket_hb";
          return "ticket_out"
        }
        if (s >= 0 || s <= 20) {
          return "ticket_warn"
        }
      }
      return "ticket_out"
    }

    function hb(col, cc) {
      for (var i in cc) {
        var c = cc[i];
        var n = class_map[c] || 22;
        var s = col[n];
        if (col[35].indexOf(c) == -1) {
          continue;
        }
        if (s == '') {
          continue;
        }
        if (s == '--') {
          continue;
        }
        if (s == '有') {
          return s
        }
        if (s == '无') {
          if (col[37] > 0 && col[38] != "null" && col[38].indexOf(c) == -1) return "候";
          return s;
        }
        if (s >= 0) {
          return s
        }
      }
      return ""
    }

    function ticketcolor2(col, cc) {
      for (var i in cc) {
        var c = cc[i];
        var n = headerkey[class_map[c] || 22] || 'qt_num';
        var s = col[n];
        if (col['seat_types'].indexOf(c) == -1) {
          continue;
        }
        if (s == '') {
          continue;
        }
        if (s == '--') {
          continue;
        }
        if (s == '有' || s > 20) {
          return "ticket_full"
        }
        if (s == '无') {
          if (col['houbu_seat_limit'] != undefined && col['houbu_seat_limit'] != "null" && col['houbu_seat_limit'].indexOf(c) == -1) return "ticket_hb";
          return "ticket_out"
        }
        if (s >= 0 || s <= 20) {
          return "ticket_warn"
        }
      }
      return "ticket_out"
    }

    function hb2(col, cc) {
      for (var i in cc) {
        var c = cc[i];
        var n = headerkey[class_map[c] || 22] || 'qt_num';
        var s = col[n];
        if (col['seat_types'].indexOf(c) == -1) {
          continue;
        }
        if (s == '') {
          continue;
        }
        if (s == '--') {
          continue;
        }
        if (s == '有') {
          return s
        }
        if (s == '无') {
          // col['houbu_train_flag'] > 0 && 
          if (col['houbu_seat_limit'] != undefined && col['houbu_seat_limit'] != "null" && col['houbu_seat_limit'].indexOf(c) == -1) return "候";
          return s;
        }
        if (s >= 0) {
          return s
        }
      }
      return ""
    }

    function ticketprice(str, cc) {
      if (typeof (str) != "string") {
        return ""
      }
      for (var i in cc) {
        var c = cc[i];
        for (var i = 0; i + 9 < str.length; i += 10) {
          if (c == str[i]) {
            return str.slice(i + 1, i + 5).replace(/^[0]{1,3}/, "") + "." + str.slice(i + 5, i + 6)
          }
        }
      }
      return ""
    }


    function ticketdiscount(str, cc) {
      if (typeof (str) != "string") {
        return ""
      }
      for (var i in cc) {
        var c = cc[i];
        for (var i = 0; i + 1 < str.length; i += 2) {
          if (c == str[i]) {
            dis = str.slice(i + 1, i + 2)
            if (dis == '1') {
              return ' ticket_discount'
            }
            if (dis == '0') {
              return ''
            }
          }
        }
      }
      return ""
    }


    // #004080
    // #113997
    // #cc4c33
    // #305030

    // #a80022 400AF
    // #bf9540 400BF
    // #3d668f CRH5A 蓝绿腰线

    // #dedbd3 CR200J 白色

    function ticketHTML(result, map) {
      var str = "";
      str += "<table>";
      str += (
        "<tr>\n"
        + "<td title=\"" + header[2] + "\" width='48px'>" + header[3] + "</td>\n"
        + "<td title=\"22 " + header[22] + "\">" + " " + "</td>\n"
        + "<td title=\"21|32|20|25 " + header[21] + "/" + header[32] + "/" + header[20] + "/" + header[25] + "\">" + "6" + "</td>\n"
        + "<td title=\"23|27 " + header[23] + "/" + header[27] + "\">" + "4" + "</td>\n"
        + "<td title=\"28|33 " + header[28] + "/" + header[33] + "\">" + "3" + "</td>\n"
        + "<td title=\"24|31 " + header[24] + "/" + header[31] + "\">" + "2" + "</td>\n"
        + "<td title=\"29|30 " + header[29] + "/" + header[30] + "\">" + "1" + "</td>\n"
        + "<td title=\"26\">" + header[26] + "</td>\n"
        + "<td title=\"" + header[16] + "\">" + header[8] + "</td>\n"
        + "<td title=\"" + header[17] + "\">" + header[9] + "</td>\n"
        + "<td>" + "站" + "</td>\n"
        + "<td>" + header[10] + "</td>\n"
        + "<td title=\"" + header[6] + "\">" + header[6] + "</td>\n"
        + "<td title=\"" + header[7] + "\">" + header[7] + "</td>\n"
        + "<td title=\"" + header[4] + "\">" + header[4] + "</td>\n"
        + "<td title=\"" + header[5] + "\">" + header[5] + "</td>\n"
        + "<td>" + "票价" + "</td>\n"
        + "<td title=\"yp_ex\">" + header[34] + "</td>\n"
        + "<td title=\"seat_types\">" + header[35] + "</td>\n"
        + "<td>" + header[13] + "</td>\n"
        + "<td title=\"train_seat_feature\">" + header[14] + "</td>\n"
        + "<td title=\"location_code\">" + header[15] + "</td>\n"
        + "<td>" + header[18] + "</td>\n"
        + "<td title=\"" + header[0] + "\n" + header[12] + "\">" + header[1] + "|" + header[19] + "|" + header[11] + "|" + header[36] + "|" + header[37] + "|" + header[38] + "</td>\n"
        + "</tr>\n"
      );
      for (i = 0; i < result.length; i++) {
        col = result[i].split("|");
        sleeper = is_sleeper(col[8], col[9], col[10]);
        str += (
          "<tr class=\"" + "hide" + col[3][0] + (col[19] > 0 ? " ctl" : "") + "\">\n"
          + "<td class=\"type" + traintype(col[3], col[14]) + "\" title=\"" + col[2] + "\" onclick=\"getSch(schURL('" + col[2] + "','" + col[4] + "','" + col[5] + "','" + col[13] + "'))\">" + col[3] + "</td>\n"
          + "<td class=\"" + ticketcolor(col, 'QH5LCKB0') + "\">" + (hb(col, 'QH5LCKB0') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor(col, '6A9PQE') + "\">" + (hb(col, '6A9PQE') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor(col, '4IS') + "\">" + (hb(col, '4IS') || "-") + "</td>\n" // ?S
          + "<td class=\"" + ticketcolor(col, '3FJ') + (sleeper ? " seat_match" : "") + "\">" + (hb(col, '3FJ') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor(col, '2M7') + "\">" + (hb(col, '2M7') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor(col, '1O8') + (!sleeper ? " seat_match" : " seat_warn") + "\">" + (hb(col, '1O8') || "-") + "</td>\n"
          + "<td class=\"\" style=\"font-weight: lighter;\">" + (col[26] || "-") + "</td>\n"
          + "<td title=\"" + col[16] + "\">" + col[8] + "</td>\n"
          + "<td title=\"" + col[17] + "\">" + col[9] + "</td>\n"
          + "<td style=\"text-align: right;\">" + (col[17] - col[16]) + "</td>\n"
          + "<td>" + col[10] + "</td>\n"
          + "<td title=\"" + col[6] + "\">" + map[col[6]] + "</td>\n"
          + "<td title=\"" + col[7] + "\">" + map[col[7]] + "</td>\n"
          + "<td title=\"" + col[4] + "\">" + name(col[4]) + "</td>\n"
          + "<td title=\"" + col[5] + "\">" + name(col[5]) + "</td>\n"
          + "<td class=\"" + ticketdiscount(col[34], (sleeper ? "3456FAJI12OM87" : "12OM873456FAJI")) + "\" style=\"text-align: right;\">" + ticketprice(col[39], (sleeper ? "3456FAJI12OM87" : "12OM873456FAJI")) + "</td>\n"
          + "<td>" + col[34] + "</td>\n"
          + "<td>" + col[35] + "</td>\n"
          + "<td>" + col[13] + "</td>\n"
          + "<td>" + col[14] + "</td>\n"
          + "<td>" + col[15] + "</td>\n"
          + "<td>" + col[18] + "</td>\n"
          + "<td title=\"secretStr " + col[0] + "\nyp_info " + col[12] + "\">" + col[1].replace(/<[^>]+>/g, " ") + "|" + col[19] + "|" + col[11] + "|" + (col[36] > 0 ? "兑" : "") + "|" + (col[37] > 0 ? "候补" : "") + "|" + col[38] + "</td>\n"
          + "</tr>\n"
        );

        console.log(
          //col[1] + "\t|" + 
          col[2] + "|" +
          (col[18] > 0 ? col[18] : " ") + "|" +
          col[4] + "|" +
          col[5] + "|" +
          col[16] + "|" +
          col[6] + "|" +
          col[17] + "|" +
          col[7] + "|" +
          col[8] + "|" +
          col[9] + "|" +
          col[10] + "|" +
          col[11] + "|" +
          col[13] + "|" +
          col[14] + "|" +
          col[15] + "|" +
          col[19] + "|" +
          col[20] + "\t|" +
          col[21] + "\t|" +
          col[22] + "\t|" +
          col[23] + "\t|" +
          col[24] + "\t|" +
          col[25] + "\t|" +
          col[26] + "\t|" +
          col[27] + "\t|" +
          col[28] + "\t|" +
          col[29] + "\t|" +
          col[30] + "\t|" +
          col[31] + "\t|" +
          col[32] + "\t|" +
          col[33] + "\t|" +
          col[3] + "\t|" +
          col[34] + "\t|" +
          col[35] + "\t|" +
          col[36] + "\t|" +
          col[37] + "\t|" +
          col[38]// + "\t|" + 
          //col[0] + "\t|" + 
          //col[12] + "\t|" + 
          //col[36]
        );
      }
      str += "</table>";
      return str;
    }


    // https://www.12306.cn/kfzmpt/lcxxcx/init
    function getlcxxcx(from, to, date) {
      var from_station_telecode = telecode(from);
      var to_station_telecode = telecode(to);
      if (!from_station_telecode) {
        return;
      }
      if (!to_station_telecode) {
        return;
      }
      //成人ADULT 学生0X00
      var url = "https://www.12306.cn/kfzmpt/lcxxcx/query?purpose_codes=ADULT&queryDate=" + date
        + "&from_station=" + from_station_telecode
        + "&to_station=" + to_station_telecode;
      if (!document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode)) {
        document.getElementById("ticket").innerHTML =
          "<div style=\"overflow-x:scroll;\" id=\"" + date + "_" + from_station_telecode + "_" + to_station_telecode + "\">"
          + date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
          + "</div>\n" + document.getElementById("ticket").innerHTML;
      }
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if ([200, 304].indexOf(xhr.status) > -1) {
            var j = JSON.parse(xhr.responseText);
            if (j.data.flag == false) {
              j.data.message
              document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode).innerHTML =
                date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
                + " " + j.data.message;
            }
            document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode).innerHTML =
              date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
              + " X-Via: " + xhr.getResponseHeader("X-Via") + "<br />\n"
              + lcxxcxHTML(j.data.datas);
          } else {
            document.getElementById(date + "_" + from_station_telecode + "_" + to_station_telecode).innerHTML =
              date + " " + name(from_station_telecode) + " " + name(to_station_telecode)
              + " " + xhr.status + " " + (xhr.statusText || "error");
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    function is_sleeper(s, e, d) {
      //s (5)8-24
      //e 6-22(25)
      if (d <= "02:00") {
        return 0 // "12OM87346FAJI short"
      }
      if (d >= "20:00") {
        return 1 // "346FAJI12OM87 long"
      }
      if (s >= e && e >= "02:00") {
        return 1 // "346FAJI12OM87"
      }
      if (s < e && (s <= "04:00")) {
        return 1 //"346FAJI12OM87 night"
      }
      return 0 //"12OM87346FAJI other"
    }
    /*
    //test
    console.log(is_sleeper("12:00","05:00","41:00"), 3)
    console.log(is_sleeper("18:00","06:00","36:00"), 3)
    console.log(is_sleeper("20:00","06:00","10:00"), 3)
    console.log(is_sleeper("20:00","11:00","15:00"), 3)
    console.log(is_sleeper("19:00","06:00","11:00"), 3)
    console.log(is_sleeper("22:00","12:00","14:00"), 3)
    console.log(is_sleeper("16:00","10:00","18:00"), 3)
    console.log(is_sleeper("23:00","06:00","07:00"),3)
    console.log(is_sleeper("01:00","13:00","12:00"),3)
    console.log(is_sleeper("05:00","24:00","19:00"),1)
    console.log(is_sleeper("18:00","01:00","07:00"),1)
    console.log(is_sleeper("08:00","04:00","10:00"),3)
    console.log(is_sleeper("23:00","03:00","04:00"),3)
    console.log(is_sleeper("23:00","04:00","05:00"),3)
    console.log(is_sleeper("01:00","05:00","04:00"),3)
    console.log(is_sleeper("04:00","05:00","01:00"),1)
    */

    function lcxxcxHTML(datas) {
      var str = "";
      str += "<div><table>";
      str += (
        "<tr>\n"
        + "<td class=\"abs\" title=\"" + header[2] + "\" width='48px'>" + header[3] + "</td>\n"
        + "<td title=\"" + header[2] + "\" width='48px'>" + header[3] + "</td>\n"
        + "<td title=\"22 " + header[22] + "\">" + " " + "</td>\n"
        + "<td title=\"21|32|20|25 " + header[21] + "/" + header[32] + "/" + header[20] + "/" + header[25] + "\">" + "6" + "</td>\n"
        + "<td title=\"23|27 " + header[23] + "/" + header[27] + "\">" + "RW" + "</td>\n"
        + "<td title=\"28|33 " + header[28] + "/" + header[33] + "\">" + "YW" + "</td>\n"
        + "<td title=\"24|31 " + header[24] + "/" + header[31] + "\">" + "RZ" + "</td>\n"
        + "<td title=\"29|30 " + header[29] + "/" + header[30] + "\">" + "YZ" + "</td>\n"
        + "<td title=\"26\">" + header[26] + "</td>\n"
        + "<td title=\"" + header[16] + "\">" + header[8] + "</td>\n"
        + "<td title=\"" + header[17] + "\">" + header[9] + "</td>\n"
        + "<td>" + "站" + "</td>\n"
        + "<td>" + header[10] + "</td>\n"
        + "<td title=\"" + header[6] + "\">" + header[6] + "</td>\n"
        + "<td title=\"" + header[7] + "\">" + header[7] + "</td>\n"
        + "<td title=\"" + header[4] + "\">" + header[4] + "</td>\n"
        + "<td title=\"" + header[5] + "\">" + header[5] + "</td>\n"
        + "<td>" + "票价" + "</td>\n"
        + "<td title=\"yp_ex\">" + header[34] + "</td>\n"
        + "<td title=\"seat_types\">" + header[35] + "</td>\n"
        + "<td>" + header[13] + "</td>\n"
        + "<td title=\"train_seat_feature\">" + header[14] + "</td>\n"
        + "<td title=\"location_code\">" + header[15] + "</td>\n"
        + "<td>" + header[18] + "</td>\n"
        + "<td title=\"" + header[12] + "\">" + header[1] + "|" + header[19] + "|" + header[11] + "|" + header[36] + "|" + header[37] + "|" + header[38] + "</td>\n"
        + "</tr>\n"
      );
      var min = 99;
      for (i = 0; i < datas.length; i++) {
        col = datas[i];
        var a = (col[headerkey[17]] - col[headerkey[16]]);
        if (a < min && (col[headerkey[3]][0] == 'G')) {
          min = a;
        }
      }
      for (i = 0; i < datas.length; i++) {
        col = datas[i];
        sleeper = is_sleeper(col[headerkey[8]], col[headerkey[9]], col[headerkey[10]]);
        str += (
          "<tr class=\"hide" + col[headerkey[3]][0] + (col[headerkey[19]] > 0 ? " ctl" : "") + (((col[headerkey[3]][0] == 'G') && ((col[headerkey[17]] - col[headerkey[16]]) > min + 1)) ? " hideG-" : "") + "\">\n"
          + "<td class=\"abs type" + traintype(col[headerkey[3]], col[headerkey[14]]) + "\" title=\"" + col[headerkey[2]] + "\" onclick=\"getSch(schURL('" + col[headerkey[2]] + "','" + col[headerkey[4]] + "','" + col[headerkey[5]] + "','" + col[headerkey[13]] + "'))\">" + col[headerkey[3]] + "</td>\n"
          + "<td class=\"type" + traintype(col[headerkey[3]], col[headerkey[14]]) + "\" title=\"" + col[headerkey[2]] + "\" onclick=\"getSch(schURL('" + col[headerkey[2]] + "','" + col[headerkey[4]] + "','" + col[headerkey[5]] + "','" + col[headerkey[13]] + "'))\">" + col[headerkey[3]] + "</td>\n"
          + "<td class=\"" + ticketcolor2(col, 'QH5LCKB0') + "\">" + (hb2(col, 'QH5LCKB0') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor2(col, '6A9PQE') + "\">" + (hb2(col, '6A9PQE') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor2(col, '4IS') + "\">" + (hb2(col, '4IS') || "-") + "</td>\n" // ?S
          + "<td class=\"" + ticketcolor2(col, '3FJ') + (sleeper ? " seat_match" : "") + "\">" + (hb2(col, '3FJ') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor2(col, '2M7') + "\">" + (hb2(col, '2M7') || "-") + "</td>\n"
          + "<td class=\"" + ticketcolor2(col, '1O8') + (!sleeper ? " seat_match" : " seat_warn") + "\">" + (hb2(col, '1O8') || "-") + "</td>\n"
          + "<td class=\"\" style=\"font-weight: lighter;\">" + (col[headerkey[26]] || "-") + "</td>\n"
          + "<td title=\"" + col[headerkey[16]] + "\">" + col[headerkey[8]] + "</td>\n"
          + "<td title=\"" + col[headerkey[17]] + "\">" + col[headerkey[9]] + "</td>\n"
          + "<td style=\"text-align: right;\">" + (col[headerkey[17]] - col[headerkey[16]]) + "</td>\n"
          + "<td>" + col[headerkey[10]] + "</td>\n"
          + "<td title=\"" + col[headerkey[6]] + "\">" + name(col[headerkey[6]]) + "</td>\n"
          + "<td title=\"" + col[headerkey[7]] + "\">" + name(col[headerkey[7]]) + "</td>\n"
          + "<td title=\"" + col[headerkey[4]] + "\">" + name(col[headerkey[4]]) + "</td>\n"
          + "<td title=\"" + col[headerkey[5]] + "\">" + name(col[headerkey[5]]) + "</td>\n"
          + "<td class=\"" + ticketdiscount(col['yp_ex'], (sleeper ? "3456FAJI12OM87" : "12OM873456FAJI")) + "\" style=\"text-align: right;\">" + ticketprice(col['yp_info'], (sleeper ? "3456FAJI12OM87" : "12OM873456FAJI")) + "</td>\n"
          + "<td>" + col[headerkey[34]] + "</td>\n"
          + "<td>" + col[headerkey[35]] + "</td>\n"
          + "<td>" + col[headerkey[13]] + "</td>\n"
          + "<td>" + (col[headerkey[14]] || "") + "</td>\n"
          + "<td>" + col[headerkey[15]] + "</td>\n"
          + "<td>" + col[headerkey[18]] + "</td>\n"
          + "<td title=\"yp_info " + col['yp_info'] + "\">" + (col['note'] || col['controlled_train_message'] || '预订').replace(/<[^>]+>/g, " ") + "|" + col[headerkey[19]] + "|" + col[headerkey[11]] + "|" + (col['exchange_train_flag'] > 0 ? "兑" : "") + "|" + (col['houbu_train_flag'] > 0 ? "候补" : "") + "|" + (col['houbu_seat_limit'] || "") + "</td>\n"
          + "</tr>\n"
        );

        console.log(
          col[headerkey[2]] + "|" +
          (col[headerkey[18]] > 0 ? col[headerkey[18]] : " ") + "|" +
          col[headerkey[4]] + "|" +
          col[headerkey[5]] + "|" +
          col[headerkey[16]] + "|" +
          col[headerkey[6]] + "|" +
          col[headerkey[17]] + "|" +
          col[headerkey[7]] + "|" +
          col[headerkey[8]] + "|" +
          col[headerkey[9]] + "|" +
          col[headerkey[10]] + "|" +
          col[headerkey[11]] + "|" +
          col[headerkey[13]] + "|" +
          col[headerkey[14]] + "|" +
          col[headerkey[15]] + "|" +
          col[headerkey[19]] + "|" +
          col[headerkey[20]] + "\t|" +
          col[headerkey[21]] + "\t|" +
          col[headerkey[22]] + "\t|" +
          col[headerkey[23]] + "\t|" +
          col[headerkey[24]] + "\t|" +
          col[headerkey[25]] + "\t|" +
          col[headerkey[26]] + "\t|" +
          col[headerkey[27]] + "\t|" +
          col[headerkey[28]] + "\t|" +
          col[headerkey[29]] + "\t|" +
          col[headerkey[30]] + "\t|" +
          col[headerkey[31]] + "\t|" +
          col[headerkey[32]] + "\t|" +
          col[headerkey[33]] + "\t|" +
          col[headerkey[3]] + "\t|" +
          col[headerkey[34]] + "\t|" +
          col[headerkey[35]] + "\t|" +
          col[headerkey[36]] + "\t|" +
          col[headerkey[37]] + "\t|" +
          col[headerkey[38]] + "\t|" +
          col[headerkey[12]]// + "\t|" + 
          //col[headerkey[36]]
        );
      }
      str += "</table></div>";
      return str;
    }

    function search_train_list(str) {
      //console.log("search_train_list()" + str);
      var result = "";
      var sch = "";
      var date = document.getElementById("date").value;
      var re = new RegExp(document.getElementById('keyword').value, "i");
      document.getElementById("sch").innerHTML = "";
      for (type in train_list[date]) {
        for (i in train_list[date][type]) {
          t = train_list[date][type][i];
          if (re.test(t.station_train_code)) { // if(t.station_train_code.includes(str)) {
            match = t.station_train_code.match(/(.*)\((.*)-(.*)\)/);
            url = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + t.train_no + "&from_station_telecode=" + telecode(match[2]) + "&to_station_telecode=" + telecode(match[3]) + "&depart_date=" + date;
            result += ("<div id=\"" + match[1] + "\">" + t.train_no + " " + t.station_train_code
              + " " + (match ? (match[1] + " " + telecode(match[2]) + " " + telecode(match[3])) : '') + " " + "<a href=" + url + " target='_blank'>" + match[1] + "</a>" + "<span onclick=\"getSch('" + url + "')\">" + match[1] + "</span>" + "</div>");
            if (match[1] == str.toUpperCase()) {
              document.getElementById("sch").innerHTML = match[1] + "<br />\n";
              getSch(url);
            }
          }
        }
      }
      document.getElementById("result").innerHTML = result;
    }

    function get_search_train_csv(str) {
      if (window.train) {
        search_train_csv(str)
        return
      }
      var url = "js/train.csv"
      document.getElementById("result").innerHTML = str
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if ([200, 304].indexOf(xhr.status) > -1) {
            data = xhr.responseText.split("\n");
            window.train = []
            for (i in data) {
              var row = data[i].split(",");
              if (row.length <= 5) continue
              window.train.push({
                train_no: row[0] || "",
                from_station: row[1] || "",
                to_station: row[2] || "",
                station_train_code: row[3] || "",
                total_num: row[4] || "",
                service_type: row[5] || "", // (row[5].length & row[5] == '0') ? "无空调" : "",
                src: row[6] || "",
                date: row[7] || "",
              })
            }

            search_train_csv(str)
          } else {
            document.getElementById("result").innerHTML = str + " " + xhr.status + " " + (xhr.statusText || "error");
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      // xhr.open("GET", url, true);
      //xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    function has_a_day(s) {
      if (s == "") {
        return date
      }

      if (s[0] == '停') {
        return date
      }

      if (s[0] == '!') {
        return date
      }

      if (s[0] == '单') {
        var t_sp = s.split('&')
        return has_a_day(t_sp.length > 1 ? t_sp[1] : '')
      }

      if (s[0] == '双') {
        var t_sp = s.split('&')
        return has_a_day(t_sp.length > 1 ? t_sp[1] : '')
      }

      if (s[0] == 'w') {
        var diff = (s[1] | 0) - weekday(date)
        if (diff < 0) {
          diff += 7
        }
        return dateAdd(date, diff)
      }

      //TODO
      if (s.length < 4) {
        return date
      }

      var yyyymmdd = date.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3")
      sp = s.split("|")
      for (i in sp) {
        ssp = sp[i].split("-")
        if (ssp.length) {
          //console.log(ssp[0], ssp[ssp.length-1])
          var tail = ssp[0]
          yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
          var d0 = yyyymmdd
          var tail = ssp[ssp.length - 1]
          yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
          var d1 = yyyymmdd
          //console.log(d0, d1)
          //console.log(d, d0 <= d, d <= d1)
        }
      }

      return yyyymmdd.replace(/(\d\d\d\d)(\d\d)(\d\d)/, "$1-$2-$3")
    }

    function is_a_day(s, d) {
      //console.log("is_a_day(s, d)", s, d)
      if (s == "") {
        return 1
      }

      if (s[0] == '停') {
        return 1 - is_a_day(s.replace("停", ""), d)
      }

      if (s[0] == '!') {
        return 1 - is_a_day(s.replace("!", ""), d)
      }

      if (s[0] == '单' || s[0] == '双') {
        var t_sp = s.split('&')
        var t = t_sp[0]
        // TODO 周期
        /*if (t.indexOf(w) == -1) {
          return 0
        }*/
        return is_a_day(t_sp.length > 1 ? t_sp[1] : '', d)
      }

      if (s[0] == 'w') {
        var w = weekday(d.replace(/(\d\d\d\d)(\d\d)(\d\d)/, "$1-$2-$3"))
        if (w == 0) {
          w = 7
        }
        var t_sp = s.split('&')
        var t = t_sp[0]
        if (t.indexOf(w) == -1) {
          return 0
        }
        return is_a_day(t_sp.length > 1 ? t_sp[1] : '', d)
      }

      //TODO
      if (s.length < 4) {
        return 1
      }

      var yyyymmdd = date.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3")
      sp = s.split("|")
      for (i in sp) {
        ssp = sp[i].split("-")
        if (ssp.length) {
          //console.log(ssp[0], ssp[ssp.length-1])
          var tail = ssp[0]
          yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
          var d0 = yyyymmdd
          var tail = ssp[ssp.length - 1]
          yyyymmdd = yyyymmdd.slice(0, 8 - tail.length) + tail
          var d1 = yyyymmdd
          //console.log(d0, d1)
          //console.log(d, d0 <= d, d <= d1)
          if (d0 <= d && d <= d1) {
            return 1
          }
        }
      }

      return 0
    }

    //is_a_day('停200219-200315', '20200314')
    //is_a_day('191230-200123|25-0201|03|05-10|12|14|16|18|20|22|24|26|28|0301|03|05|07|09|11|13|15-0414', '2020-03-15')

    //Z81 Z80 Z81/0
    function multi_train_no(train_no, station_train_code) {
      var no = train_no.slice(2, 10).replace(/^[0]+/g, "");
      if (no == station_train_code) {
        return station_train_code;
      }
      var l = Math.min(no.length, station_train_code.length);
      var idx = 0;
      for (idx = 0; idx < l; idx++) {
        if (no[idx] != station_train_code[idx]) {
          break;
        }
      }
      if (idx < station_train_code.length) {
        return no + "/" + station_train_code.slice(idx);
      }
      return ret;
    }

    function search_train_csv(str) {
      var result = "";
      var re = new RegExp(str, "i");
      //document.getElementById("sch").innerHTML = "";
      for (i in window.train) {
        t = window.train[i];
        if (re.test(t.station_train_code)) { // if(t.station_train_code.includes(str)) { // 
          schurl = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + t.train_no + "&from_station_telecode=" + t.from_station + "&to_station_telecode=" + t.to_station + "&depart_date=" + has_a_day(t.date);
          result += ("<div id=\"" + t.station_train_code + "\">"
            + t.train_no + " " + t.from_station + " " + t.to_station
            + " " + "<span class=\"type" + traintype(t.station_train_code, t.service_type) + "\" onclick=\"getSch('" + schurl + "')\">"
            + multi_train_no(t.train_no, t.station_train_code)
            + "</span>" + " " + (name(t.from_station) || "---") + " " + (name(t.to_station) || "---")
            // + " " + t.service_type
            + " " + "<span class=\"" + (is_a_day(t.date, date.replace(/(\d\d\d\d)-(\d\d)-(\d\d)/, "$1$2$3")) ? "" : "ctl") + "\">" + t.date + "</span>"
            //+ " " + "<a href=" + schurl + " target='_blank'>" + multi_train_no(t.train_no, t.station_train_code) + "</a>" 
            + "</div>"
          );
          if (t.station_train_code == str.toUpperCase()) {
            // document.getElementById("sch").innerHTML = t.station_train_code + "<br />\n";
            getSch(schurl);
          }
        }
      }
      document.getElementById("result").innerHTML = result;
    }

    function search(str) {
      var re = /^[GDCZTKYL]{1}[1-9][0-9]{0,3}$|^[1-9][0-9]{3}$/
      if (re.test(str.toUpperCase())) {
        search_v1(str.toUpperCase())
        return false
      }
      var re2 = /^[a-zA-Z]{3}$/
      if (re2.test(str)) {
        czxx(str.toUpperCase())
        return false
      }
      if (telecode(str)) {
        czxx(telecode(str))
        return false
      }
      search_v1(str.toUpperCase())
    }

    function search_v1(str) {
      var date = document.getElementById("date").value;
      var yyyymmdd = date.replace(/-/g, "")
      var url = "https://search.12306.cn/search/v1/train/search?keyword=" + str + "&date=" + yyyymmdd
      document.getElementById("result").innerHTML = str
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if ([200, 304].indexOf(xhr.status) > -1) {
            result = ""
            var j = JSON.parse(xhr.responseText);
            if (j.status) {
              result += ("<div>" + (j.data ? j.data.length : 0) + "条</div>")
              for (i in j.data) {
                var t = j.data[i];
                schurl = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + t.train_no + "&from_station_telecode=" + telecode(t.from_station) + "&to_station_telecode=" + telecode(t.to_station) + "&depart_date=" + date;
                result += ("<div id=\"" + t.station_train_code + "\">"
                  + t.train_no + " " + telecode(t.from_station) + " " + telecode(t.to_station)
                  + " " + "<span class=\"type" + t.station_train_code[0] + "\" onclick=\"getSch('" + schurl + "')\">"
                  + t.station_train_code + "</span>" + " " + t.from_station + " " + t.to_station
                  + " " + "<a href=" + schurl + " target='_blank'>" + t.station_train_code + "</a>" + "</div>"
                );
                if (t.station_train_code == str.toUpperCase()) {
                  document.getElementById("sch").innerHTML = t.station_train_code + "<br />\n";
                  getSch(schurl);
                }
              }
            } else {
              result += j.errorMsg
            }
            document.getElementById("result").innerHTML = result;
          } else {
            document.getElementById("result").innerHTML = str + " " + xhr.status + " " + (xhr.statusText || "error");
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      // xhr.open("GET", url, true);
      //xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    function czxx(t1) {
      var date = document.getElementById("date").value;
      var url = "https://kyfw.12306.cn/otn/czxx/query?train_start_date=" + date + "&train_station_code=" + t1
      document.getElementById("result").innerHTML = t1 + " ";
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if ([200, 304].indexOf(xhr.status) > -1) {
            result = ""
            var j = JSON.parse(xhr.responseText);
            if (j.status && j.data) {
              result += ("<div>" + (j.data.data ? j.data.data.length : 0) + "趟 " + j.data.sameStations.join(" ") + "</div>")
              for (i in j.data.data) {
                var t = j.data.data[i];
                schurl = "https://kyfw.12306.cn/otn/czxx/queryByTrainNo?train_no=" + t.train_no
                  + "&from_station_telecode=" + telecode(t.start_station_name)
                  + "&to_station_telecode=" + telecode(t.end_station_name)
                  + "&depart_date=" + date;
                result += ("<div id=\"" + t.station_train_code + "\">"
                  + t.train_no + " " + telecode(t.start_station_name) + " " + telecode(t.end_station_name)
                  + " " + "<span class=\"type" + traintype(t.station_train_code, t.service_type) + "\" onclick=\"getSch('" + schurl + "')\">"
                  + t.station_train_code + "</span>" + " " + t.start_station_name + " " + t.end_station_name
                  + " " + "<a href=" + schurl + " target='_blank'>" + t.station_train_code + "</a>" + "</div>");
              }
            } else {
              result += j.errorMsg
            }
            document.getElementById("result").innerHTML = result;
          } else {
            document.getElementById("result").innerHTML = t1 + " " + xhr.status + " " + (xhr.statusText || "error");
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      // xhr.open("GET", url, true);
      //xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send();
    }

    function search_qss(str) {
      var c = search_samecity(str)
      ret = ""
      for (i in c) {
        ret += c[i] + ":" + (citys[c[i]] || "") + " "
      }
      document.getElementById("qss").innerHTML = ret;
    }

    function search_samecity(str) {
      if (!telecode(str)) {
        return
      }
      for (i in window.samecity) {
        for (j in window.samecity[i]) {
          if (window.samecity[i][j] == str) {
            return window.samecity[i] || []
          }
        }
      }
      return [str]
    }

    function qss(str) {
      if (window.samecity) {
        search_qss(str)
        return
      }
      var url = "samecity.txt"
      var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft.XMLHTTP");
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if ([200, 304].indexOf(xhr.status) > -1) {
            data = xhr.responseText.split("\n");
            window.samecity = []
            for (i in data) {
              if (data[i].length == 0) continue
              window.samecity.push(data[i].replace("\r", "").split(","))
            }

            search_qss(str)
          } else {
            document.getElementById("qss").innerHTML = ret + " " + xhr.status + " " + (xhr.statusText || "error");
          }
        }
      }
      xhr.open("GET", url.replace("https://", "/").replace("http://", "/"), true);
      xhr.send();
    }

  </script>
</body>

</html>